<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin</title>
    <link rel="stylesheet" href="style.css">
    <script src="burnin.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
            color: #333;
            position: relative;
        }
        .top-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 96px;
            background-color: rgba(146, 208, 80, 1);
            z-index: 2;
            display: flex;
            align-items: center;
            padding-right: 20px;
        }
                .top-border img {
                        max-height: 75px;
                        width: auto;
                        object-fit: contain;
                }
                .right-top-image {
                position: fixed;
                top: 0;
                right: 0;
                padding: 10px;
                        z-index: 3;
                }
                .right-top-image img {
                height: 75px;
                width: auto;
                }
        #clock {
            flex: 1;
            text-align: center;
            font-size: 48px;
            font-weight: bold;
        }
        .clock-date {
            display: block;
            font-size: 20px;
        }
        .left-border {
            position: fixed;
            top: 0;
            left: 0;
            width: 128px;
            height: 100%;
            background-color: rgba(146, 208, 80, 1);
            z-index: 1;
        }
        #toggle-rotation {
            display: block;
            width: 110px;
            margin: 110px auto 10px;
            font-size: 12px;
            background-color: blue;
            color: white;
        }
        .weather-container {
            margin-top: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }
        .weather-day {
            width: 100px;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 5px;
            background: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .weather-icon {
            font-size: 32px;
        }
        .weather-temp {
            font-size: 24px;
            font-weight: bold;
        }
        .alert-container {
            display: none;
            background-color: #ffcccc;
            color: #a00;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        .input-error { color:#a00; font-size:0.8rem; margin-left:4px; }
        .container {
            max-width: none;
            width: auto;
            margin: 120px 20px 20px 160px;
            padding: 20px;
            background-color: #fff;
            box-shadow: 0px 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            position: relative;
            z-index: 1;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: rgba(37, 64, 143, 1);
        }
        input[type="text"] {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            padding: 10px 20px;
            background-color: rgba(37, 64, 143, 1);
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .logo {
            position: absolute;
            top: 20px;
            left: 20px;
            max-width: 200px;
            max-height: 200x;
            width: auto;
            height: auto;
        }
        .tabs {
            margin: 10px 0;
        }
        .tabs a {
            text-decoration: none;
            color: #000;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-bottom: none;
            background: #eee;
            border-radius: 4px 4px 0 0;
            margin-right: 4px;
        }
        .tabs a.active {
            background: #fff;
            font-weight: bold;
        }
        .top-border .header-kpi:first-of-type,
        .top-border .header-mt {
            margin-left: 160px;
        }
        .top-border .header-kpi:last-of-type {
            margin-right: 160px;
        }
        .header-mt {
            display: flex;
            flex-direction: row; /* Explicitly force horizontal layout */
            align-items: center;
            gap: 40px; /* spacing between MTTR and MTBF */
        }
        .header-mt .header-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #config-form { display:none; margin-top:20px; }
        label { display:block; margin-top:10px; }
    </style>
</head>
<body>
    <div class="top-border">
        <img src="img/pri-logo.png" alt="PRI Logo" class="logo">
        <div class="header-kpi">
            <div class="kpi-title">Maintenance Downtime (Last Week)</div>
            <div id="downtime-value" class="kpi-value">--%</div>
        </div>
        <div class="header-mt">
            <div class="header-metric">
                <div class="kpi-title">MTTR (30d)</div>
                <div id="mttr-value" class="kpi-value">--h</div>
            </div>
            <div class="header-metric">
                <div class="kpi-title mtbf-title">MTBF (30d)</div>
                <div id="mtbf-value" class="kpi-value">--h</div>
            </div>
        </div>
        <div id="clock"></div>
        <div class="header-kpi">
            <div class="kpi-title">Planned vs Unplanned (Last Week)</div>
            <div id="planned-vs-unplanned" class="kpi-value">--% vs --%</div>
        </div>
    </div>
    <div class="right-top-image">
        <img src="img/innovation-logo.png" alt="Innovation Logo">
    </div>
    <div class="left-border">
        <button id="toggle-rotation">Pause Rotation</button>
        <div id="weather-container" class="weather-container"></div>
    </div>
    <div class="container">
        <h1>Admin</h1>
        <div class="tabs">
            <a href="/index.html">Work Orders</a>
            <a href="/pm.html">PM Work Orders</a>
            <a href="/prodstatus.html">Production Status</a>
            <a href="/kpi-by-asset.html">KPIs by Asset</a>
            <a href="/admin" class="active">Admin</a>
        </div>
        <div id="login-section">
        <label>Password: <input type="password" id="admin-pass"></label>
        <button id="login-btn">Login</button>
    </div>
    <form id="config-form">
        <label>Pages (comma separated): <input type="text" id="pages"></label>
        <label>Rotate Interval ms: <input type="number" id="interval"></label>
        <label>Columns for index.html: <input type="text" id="cols-index"></label>
        <label>Columns for pm.html: <input type="text" id="cols-pm"></label>
        <button type="submit">Save Config</button>
    </form>
    <div id="burnin-section">
        <h2>Burn-in Repair Mode</h2>
        <div id="burnin-status">
            Scheduled: <span id="burnin-sched">19:00–05:00</span><br>
            Currently: <span id="burnin-current">Inactive</span><br>
            Override: <span id="burnin-override">Off</span>
        </div>
        <label>Start: <input type="time" id="burnin-start" value="19:00"></label>
        <label>End: <input type="time" id="burnin-end" value="05:00"></label>
        <button id="save-burnin">Save Schedule</button>
        <button id="enter-burnin">Enter Burn-in Now</button>
        <button id="exit-burnin">Exit Burn-in Now</button>
    </div>
    <div id="mapping-section" style="display:none;">
        <label>Update mappings.json: <input type="file" id="mapping-file"></label>
        <button id="upload-map">Upload Mapping</button>
    </div>
    <div id="theme-section" style="display:none;">
        <h2>KPI Theme &amp; Thresholds</h2>
        <div id="theme-toast" class="alert-container"></div>
        <fieldset>
            <legend>Colors</legend>
            <div>
                <label>Good BG <input type="text" id="color-good-bg" class="hex-input"></label><span class="input-error"></span>
                <label>Good FG <input type="text" id="color-good-fg" class="hex-input"></label><span class="input-error"></span>
                <label>Warn BG <input type="text" id="color-warn-bg" class="hex-input"></label><span class="input-error"></span>
                <label>Warn FG <input type="text" id="color-warn-fg" class="hex-input"></label><span class="input-error"></span>
                <label>Bad BG <input type="text" id="color-bad-bg" class="hex-input"></label><span class="input-error"></span>
                <label>Bad FG <input type="text" id="color-bad-fg" class="hex-input"></label><span class="input-error"></span>
                <label>Neutral BG <input type="text" id="color-neutral-bg" class="hex-input"></label><span class="input-error"></span>
                <label>Neutral FG <input type="text" id="color-neutral-fg" class="hex-input"></label><span class="input-error"></span>
            </div>
        </fieldset>
        <fieldset>
            <legend>Thresholds</legend>
            <div>
                <label>Downtime % goodMax <input type="number" id="thr-downtimePct-goodMax" class="num-input"></label><span class="input-error"></span>
                <label>Downtime % warnMax <input type="number" id="thr-downtimePct-warnMax" class="num-input"></label><span class="input-error"></span>
                <label>Planned % goodMin <input type="number" id="thr-plannedPct-goodMin" class="num-input"></label><span class="input-error"></span>
                <label>Planned % warnMin <input type="number" id="thr-plannedPct-warnMin" class="num-input"></label><span class="input-error"></span>
                <label>Unplanned % goodMax <input type="number" id="thr-unplannedPct-goodMax" class="num-input"></label><span class="input-error"></span>
                <label>Unplanned % warnMax <input type="number" id="thr-unplannedPct-warnMax" class="num-input"></label><span class="input-error"></span>
                <label>MTTR (h) goodMax <input type="number" id="thr-mttrHours-goodMax" class="num-input"></label><span class="input-error"></span>
                <label>MTTR (h) warnMax <input type="number" id="thr-mttrHours-warnMax" class="num-input"></label><span class="input-error"></span>
                <label>MTBF (h) goodMin <input type="number" id="thr-mtbfHours-goodMin" class="num-input"></label><span class="input-error"></span>
                <label>MTBF (h) warnMin <input type="number" id="thr-mtbfHours-warnMin" class="num-input"></label><span class="input-error"></span>
            </div>
        </fieldset>
        <button id="save-theme" disabled>Save Theme</button>
        <button id="reset-theme">Reset to Defaults</button>
    </div>
    <section class="card">
        <h3>Update Schedules</h3>
        <p>Edit cron expressions; toggle enable. Server reloads schedules on save.</p>
        <table id="sched-table">
            <thead><tr><th>Name</th><th>Cron</th><th>Enabled</th></tr></thead>
            <tbody></tbody>
        </table>
        <button id="sched-save">Save Schedules</button>
        <div id="sched-status" style="margin-top:.5rem;color:#555;"></div>
    </section>
    <section class="card">
      <h3>Run Now</h3>
      <div class="row-controls" style="display:flex;gap:.5rem;flex-wrap:wrap">
        <button id="run-header">Run Header KPIs</button>
        <button id="run-byasset">Run By-Asset KPIs</button>
        <button id="run-wo-index">Run WO: Index</button>
        <button id="run-wo-pm">Run WO: PM</button>
        <button id="run-wo-status">Run WO: Prod Status</button>
        <button id="run-all">Refresh All</button>
      </div>
      <div id="run-status" style="margin-top:.5rem;color:#555;"></div>
    </section>
    </div>
    <script>
        const rotateBtn = document.getElementById('toggle-rotation');
        const burnStart = document.getElementById('burnin-start');
        const burnEnd = document.getElementById('burnin-end');
        const burnSchedSpan = document.getElementById('burnin-sched');
        const burnCurrentSpan = document.getElementById('burnin-current');
        const burnOverrideSpan = document.getElementById('burnin-override');
        function updateRotateButton() {
            const paused = localStorage.getItem('rotationPaused') === 'true';
            rotateBtn.textContent = paused ? 'Resume Rotation' : 'Pause Rotation';
            rotateBtn.style.backgroundColor = paused ? 'red' : 'blue';
            rotateBtn.style.color = 'white';
        }
        rotateBtn.addEventListener('click', () => {
            const paused = localStorage.getItem('rotationPaused') === 'true';
            localStorage.setItem('rotationPaused', paused ? 'false' : 'true');
            updateRotateButton();
        });
        updateRotateButton();
        let config = {};
        function isBurnActive(sched){
            const [sh,sm]=sched.start.split(':').map(Number);
            const [eh,em]=sched.end.split(':').map(Number);
            const now=new Date();
            const start=new Date(); start.setHours(sh,sm,0,0);
            const end=new Date(); end.setHours(eh,em,0,0);
            const inWindow = start<=end ? (now>=start && now<end) : (now>=start || now<end);
            const override=localStorage.getItem('burnInOverride');
            const active=(inWindow && override!=='off') || override==='on';
            return {active, override};
        }
        function updateBurninUI(){
            const sched=config.burnInSchedule || {start:'19:00',end:'05:00'};
            burnStart.value=sched.start;
            burnEnd.value=sched.end;
            burnSchedSpan.textContent=`${sched.start}–${sched.end}`;
            const {active, override} = isBurnActive(sched);
            burnCurrentSpan.textContent = active ? 'Active' : 'Inactive';
            burnOverrideSpan.textContent = override==='on' ? 'On' : 'Off';
        }
        fetch('/config.json')
            .then(r => r.json())
            .then(cfg => { config = cfg; updateBurninUI(); rotatePages(); })
            .catch(() => { config = {}; updateBurninUI(); });

        function rotatePages() {
            if (!config.pages) return;
            const page = window.location.pathname.split('/').pop() || 'admin.html';
            const pages = config.pages;
            const interval = config.interval || 15000;
            const next = pages[(pages.indexOf(page) + 1) % pages.length];
            setTimeout(async () => {
                if (await checkBurnIn()) return;
                if (localStorage.getItem('rotationPaused') === 'true') return;
                if (next && next !== page) window.location.href = '/' + next;
            }, interval);
        }

        let adminPass = '';
        document.getElementById('login-btn').onclick = async () => {
            adminPass = document.getElementById('admin-pass').value;
            const res = await fetch('/api/config');
            const cfg = await res.json();
            config = cfg;
            updateBurninUI();
            document.getElementById('pages').value = cfg.pages.join(',');
            document.getElementById('interval').value = cfg.interval;
            document.getElementById('cols-index').value = (cfg.columns['index.html'] || []).join(',');
            document.getElementById('cols-pm').value = (cfg.columns['pm.html'] || []).join(',');
            document.getElementById('config-form').style.display = 'block';
            document.getElementById('mapping-section').style.display = 'block';
            document.getElementById('theme-section').style.display = 'block';
            document.getElementById('login-section').style.display = 'none';
        };
        document.getElementById('config-form').onsubmit = async e => {
            e.preventDefault();
            const cfg = {
                pages: document.getElementById('pages').value.split(',').map(s=>s.trim()).filter(Boolean),
                interval: parseInt(document.getElementById('interval').value,10),
                columns: {
                    'index.html': document.getElementById('cols-index').value.split(',').map(s=>s.trim()).filter(Boolean),
                    'pm.html': document.getElementById('cols-pm').value.split(',').map(s=>s.trim()).filter(Boolean)
                }
            };
            await fetch('/api/config', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({password: adminPass, config: cfg})
            });
            alert('Config saved');
        };
        document.getElementById('save-burnin').onclick = async () => {
            config.burnInSchedule = { start: burnStart.value, end: burnEnd.value };
            await fetch('/api/config', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ password: adminPass, config })
            });
            updateBurninUI();
            alert('Schedule saved');
        };
        document.getElementById('enter-burnin').onclick = () => {
            localStorage.setItem('burnInOverride','on');
            const sched = config.burnInSchedule || {start:'19:00', end:'05:00'};
            const now = new Date();
            const [sh,sm] = sched.start.split(':').map(Number);
            const [eh,em] = sched.end.split(':').map(Number);
            const start = new Date(now); start.setHours(sh,sm,0,0);
            const end = new Date(now); end.setHours(eh,em,0,0);
            if (start <= end) {
                if (now >= end) end.setDate(end.getDate() + 1);
            } else {
                if ((now >= end && now < start) || now >= start) end.setDate(end.getDate() + 1);
            }
            localStorage.setItem('burnInOverrideEnd', end.getTime());
            localStorage.setItem('lastPage', window.location.pathname);
            window.location.href = '/burnin.html';
        };
        document.getElementById('exit-burnin').onclick = () => {
            localStorage.removeItem('burnInOverride');
            localStorage.removeItem('burnInOverrideEnd');
            window.location.href = '/';
        };
        document.getElementById('upload-map').onclick = async () => {
            const file = document.getElementById('mapping-file').files[0];
            if(!file) return;
            const text = await file.text();
            await fetch('/api/mappings', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({password: adminPass, mappings: JSON.parse(text)})
            });
            alert('Mappings updated');
        };
        document.getElementById('refresh-cache').onclick = () => {
            fetch('/api/cache/refresh', { method: 'POST' })
                .then(r => r.json()).then(console.log);
        };
    </script>
<script>
    // clock
    function updateClock() {
        const now = new Date();
        const dateFmt = new Intl.DateTimeFormat('en-US', {
            timeZone: 'America/Indiana/Indianapolis',
            weekday:'short', month:'short', day:'numeric', year:'numeric'
        });
        const timeFmt = new Intl.DateTimeFormat('en-US', {
            timeZone: 'America/Indiana/Indianapolis',
            hour:'numeric', minute:'2-digit', second:'2-digit'
        });
        document.getElementById('clock').innerHTML =
            `<span class="clock-date">${dateFmt.format(now)}</span>${timeFmt.format(now)}`;
    }
    setInterval(updateClock, 1000);
    updateClock();
</script>
<script>
  async function runJob(name) {
    const res = await fetch('/api/admin/run', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ job: name })
    });
    const el = document.getElementById('run-status');
    if (el) el.textContent = res.ok ? `Ran ${name}` : `Failed ${name}`;
  }

  // GUARD EACH LOOKUP
  (document.getElementById('run-header')   || {}).onclick = ()=>runJob('header_kpis');
  (document.getElementById('run-byasset')  || {}).onclick = ()=>runJob('by_asset_kpis');
  (document.getElementById('run-wo-index') || {}).onclick = ()=>runJob('work_orders_index');
  (document.getElementById('run-wo-pm')    || {}).onclick = ()=>runJob('work_orders_pm');
  (document.getElementById('run-wo-status')|| {}).onclick = ()=>runJob('work_orders_status');
  (document.getElementById('run-all')      || {}).onclick = async ()=>{
    const res = await fetch('/api/admin/refresh-all', { method: 'POST' });
    const el = document.getElementById('run-status');
    if (el) el.textContent = res.ok ? 'Refreshed all' : 'Refresh all failed';
  };
</script>
<script type="module" src="js/header-kpis.js" defer></script>
<script type="module" src="/js/admin.js"></script>
</body>
</html>
