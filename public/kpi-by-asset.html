<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>KPIs by Asset</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/style.css">
    <script src="burnin.js" defer></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f0f0; color:#333; position:relative; }
    .top-border { position:fixed; top:0; left:0; width:100%; height:96px; background:rgba(146,208,80,1); z-index:2; display:flex; align-items:center; padding-right:20px; }
    .top-border img { max-height:75px; width:auto; object-fit:contain; }
    .right-top-image { position:fixed; top:0; right:0; padding:10px; z-index:3; }
    .right-top-image img { height:75px; width:auto; }
    #clock { flex:1; text-align:center; font-size:48px; font-weight:bold; }
    .clock-date { display:block; font-size:20px; }
    .left-border { position:fixed; top:0; left:0; width:128px; height:100%; background:rgba(146,208,80,1); z-index:1; }
    #toggle-rotation { display:block; width:110px; margin:110px auto 10px; font-size:12px; background-color: blue; color: white; }
    #refresh-timer { margin-left:10px; font-weight:bold; }
    .container { max-width: none; width: auto; margin:120px 20px 20px 160px; padding:20px; background:#fff; box-shadow:0 2px 4px rgba(0,0,0,0.1); border-radius:8px; position:relative; z-index:1; }
    h1 { text-align:center; margin-bottom:20px; color:rgba(37,64,143,1); }
    table { width:100%; border-collapse:collapse; border:1px solid #ddd; font-size:1.8rem; }
    .table-wrap { max-height: none; overflow: visible; }
    th, td { padding:12px; text-align:center; border-bottom:1px solid #ddd; }
    th { background:#25408F; color:#fff; }
    tbody tr:nth-child(even) { background:#e0e0e0; }
    tbody tr:nth-child(odd) { background:#fff; }
    .logo { position:absolute; top:20px; left:20px; max-width:200px; max-height:200px; width:auto; height:auto; }
    .tabs { margin:10px 0; }
    .tabs a { text-decoration:none; color:#000; padding:8px 12px; border:1px solid #ccc; border-bottom:none; background:#eee; border-radius:4px 4px 0 0; margin-right:4px; }
    .tabs a.active { background:#fff; font-weight:bold; }
    .top-border .header-kpi:first-of-type,
    .top-border .header-mt { margin-left:160px; }
    .top-border .header-kpi:last-of-type { margin-right:160px; }
    .header-mt {
    display: flex;
    flex-direction: row; /* Explicitly force horizontal layout */
    align-items: center;
    gap: 40px; /* spacing between MTTR and MTBF */
}
    .header-mt .header-metric { display:flex; flex-direction:column; align-items:center; }
    .true-overall-row { padding-bottom:4px; }
    .kpi-tile { background:#2f3547; color:#fff; padding:10px 14px; border-radius:10px; margin-right:10px; min-width:140px; display:inline-block; }
    .kpi-tile.good { background:#10B981; color:#0B1B13; }
    .kpi-tile.warn { background:#FBBF24; color:#1B1403; }
    .kpi-tile.bad  { background:#EF4444; color:#1F0D0D; }
    .kpi-tile .label { font-size:0.9rem; opacity:.85; }
    .kpi-tile .value { font-size:1.6rem; font-weight:700; }
  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div class="top-border">
    <img src="img/pri-logo.png" alt="PRI Logo" class="logo" />
    <div class="header-kpi">
      <div class="kpi-title">Maintenance Downtime (Last Week)</div>
      <div id="downtime-value" class="kpi-value">--%</div>
    </div>
    <div class="header-mt">
      <div class="header-metric">
        <div class="kpi-title">MTTR (30d)</div>
        <div id="mttr-value" class="kpi-value">--h</div>
      </div>
      <div class="header-metric">
        <div class="kpi-title mtbf-title">MTBF (30d)</div>
        <div id="mtbf-value" class="kpi-value">--h</div>
      </div>
    </div>
    <div id="clock">--:--:--</div>
    <div class="header-kpi">
      <div class="kpi-title">Planned vs Unplanned (Last Week)</div>
      <div id="planned-vs-unplanned" class="kpi-value">--% vs --%</div>
    </div>
  </div>
  <div class="right-top-image">
    <img src="img/innovation-logo.png" alt="Innovation Logo" />
  </div>
  <div class="left-border">
    <button id="toggle-rotation">Pause Rotation</button>
  </div>
  <div class="container">
    <h1>Asset KPIs <small id="last-refresh" style="font-weight:normal;font-size:0.8rem;color:#555;"></small></h1>
    <div class="tabs">
      <a href="/index.html">Work Orders</a>
      <a href="/pm.html">PM Work Orders</a>
      <a href="/prodstatus.html">Production Status</a>
      <a href="/kpi-by-asset.html" class="active">KPIs by Asset</a>
      <a href="/production.html">Transformation</a>
      <a href="/admin">Admin</a>
    </div>
    <h2>All Assets — True Overall</h2>
      <div id="true-overall-row" class="true-overall-row">
        <div class="kpi-tile" id="tile-downtime">
          <div class="label">
            Downtime %
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Downtime %">i</span>
              <span class="tooltip-panel">
                <b>Downtime %</b> = Total downtime hours ÷ scheduled hours × 100.<br>
                Scheduled hours come from each asset’s <em>HoursPerWeek</em> scaled to the selected timeframe.
              </span>
            </span>
          </div>
          <div class="value" data-testid="true-overall-downtime">--%</div>
        </div>
      
        <div class="kpi-tile" id="tile-mttr">
          <div class="label">
            MTTR (h)
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About MTTR">i</span>
              <span class="tooltip-panel">
                <b>MTTR (Mean Time To Repair)</b> = Unplanned downtime hours ÷ failure events.<br>
                Failure events are unplanned/work-request tasks with downtime &gt; 0 in the timeframe.
              </span>
            </span>
          </div>
          <div class="value" data-testid="true-overall-mttr">--</div>
        </div>
      
        <div class="kpi-tile" id="tile-mtbf">
          <div class="label">
            MTBF (h)
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About MTBF">i</span>
              <span class="tooltip-panel">
                <b>MTBF (Mean Time Between Failures)</b> = (Scheduled hours − downtime hours) ÷ failure events.<br>
                Uses the same failure-event definition as MTTR.
              </span>
            </span>
          </div>
          <div class="value" data-testid="true-overall-mtbf">--</div>
        </div>
      
        <div class="kpi-tile" id="tile-planned">
          <div class="label">
            Planned %
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Planned %">i</span>
              <span class="tooltip-panel">
                <b>Planned %</b> = Planned tasks (types 1,4) ÷ (planned + unplanned) × 100 for the selected timeframe.
              </span>
            </span>
          </div>
          <div class="value" data-testid="true-overall-planned">--%</div>
        </div>
      
        <div class="kpi-tile" id="tile-unplanned">
          <div class="label">
            Unplanned %
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Unplanned %">i</span>
              <span class="tooltip-panel">
                <b>Unplanned %</b> = Unplanned/work-request tasks (types 2,6) ÷ (planned + unplanned) × 100 for the selected timeframe.
              </span>
            </span>
          </div>
          <div class="value" data-testid="true-overall-unplanned">--%</div>
        </div>
      </div>
    <div class="controls">
      <label for="timeframe-select">Timeframe:</label>
      <select id="timeframe-select">
        <option value="currentWeek">Current Week</option>
        <option value="lastWeek">Last Week</option>
        <option value="currentMonth">Current Month</option>
        <option value="lastMonth" selected>Last Month</option>
        <option value="currentYear">Current Year</option>
        <option value="lastYear">Last Year</option>
        <option value="trailing7Days">Trailing 7 Days</option>
        <option value="trailing30Days">Trailing 30 Days</option>
        <option value="trailing12Months">Trailing 12 Months</option>
      </select>
      <span id="date-range" style="margin-left:8px; opacity:.8;"></span>
    </div>
    <div>
      <button id="refresh-button">Refresh</button>
      <span id="refresh-timer"></span>
    </div>
    <div id="error-banner" style="display:none;color:red;">Failed to load KPIs</div>
    <div id="loading" style="display:none;">
      <div class="spinner"></div>
    </div>
    <div class="table-wrap">
    <table id="kpi-by-asset">
      <thead>
        <tr>
          <th>Asset Name</th>
          
          <th>
            Downtime Hrs
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Downtime Hours">i</span>
              <span class="tooltip-panel">
                <b>Downtime Hrs</b> = Sum of downtime (seconds ÷ 3600) for completed unplanned/work-request tasks (types 2,6) in the window.
              </span>
            </span>
          </th>
      
          <th class="col-int">
            Open Count
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Open Count">i</span>
              <span class="tooltip-panel">
                <b>Open Count</b> = Count of currently open unplanned/work-request tasks (status 0 = open, 1 = in progress).
              </span>
            </span>
          </th>
      
          <th class="col-int" data-testid="col-unplanned-count">
            Unplanned Count
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Unplanned Count">i</span>
              <span class="tooltip-panel">
                <b>Unplanned Count</b> = Number of unplanned/work-request tasks (types 2,6) completed in the timeframe.
              </span>
            </span>
          </th>
      
          <th class="col-int" data-testid="col-failure-events">
            Failure Events
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Failure Events">i</span>
              <span class="tooltip-panel">
                <b>Failure Events</b> = Unplanned/work-request tasks with downtime &gt; 0 in the timeframe.
              </span>
            </span>
          </th>
      
          <th>
            Downtime %
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Downtime %">i</span>
              <span class="tooltip-panel">
                <b>Downtime %</b> = Total downtime hours ÷ scheduled hours × 100.<br>
                Scheduled hours come from each asset’s <em>HoursPerWeek</em> scaled to the timeframe.
              </span>
            </span>
          </th>
      
          <th>
            MTTR
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About MTTR">i</span>
              <span class="tooltip-panel">
                <b>MTTR (Mean Time To Repair)</b> = Unplanned downtime hours ÷ failure events.
              </span>
            </span>
          </th>
      
          <th>
            MTBF
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About MTBF">i</span>
              <span class="tooltip-panel">
                <b>MTBF (Mean Time Between Failures)</b> = (Scheduled hours − downtime hours) ÷ failure events.
              </span>
            </span>
          </th>
      
          <th>
            Planned %
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Planned %">i</span>
              <span class="tooltip-panel">
                <b>Planned %</b> = Planned tasks (types 1,4) ÷ total tasks × 100.
              </span>
            </span>
          </th>
      
          <th>
            Unplanned %
            <span class="tooltip">
              <span class="info" tabindex="0" aria-label="About Unplanned %">i</span>
              <span class="tooltip-panel">
                <b>Unplanned %</b> = Unplanned/work-request tasks (types 2,6) ÷ total tasks × 100.
              </span>
            </span>
          </th>
        </tr>
      </thead>

      <tbody id="kpi-asset-body"></tbody>
      <tfoot>
        <tr class="kpi-summary-row">
          <td class="kpi-cell"><div class="kpi-title">Total Assets</div><div id="total-assets" class="kpi-value">--</div></td>
          <td class="kpi-cell"><div class="kpi-title">Avg Downtime Hrs</div><div id="avg-downtime" class="kpi-value">--</div></td>
          <td class="kpi-cell"><div class="kpi-title">Avg Open Count</div><div id="avg-open-count" class="kpi-value">--</div></td>          <!-- NEW -->
          <td class="kpi-cell"><div class="kpi-title">Avg Unplanned Count</div><div id="avg-unplanned-count" class="kpi-value">--</div></td>
          <td class="kpi-cell"><div class="kpi-title">Avg Failure Events</div><div id="avg-failure-events" class="kpi-value">--</div></td>
          <td class="kpi-cell"><div class="kpi-title">Avg Downtime %</div><div id="avg-downtime-pct" class="kpi-value">--%</div></td>
          <td class="kpi-cell"><div class="kpi-title">Avg MTTR (h)</div><div id="avg-mttr" class="kpi-value">--</div></td>
          <td class="kpi-cell"><div class="kpi-title">Avg MTBF (h)</div><div id="avg-mtbf" class="kpi-value">--</div></td>
          <td class="kpi-cell"><div class="kpi-title">Avg Planned %</div><div id="avg-planned" class="kpi-value">--%</div></td>
          <td class="kpi-cell"><div class="kpi-title">Avg Unplanned %</div><div id="avg-unplanned" class="kpi-value">--%</div></td>
        </tr>
        <tr class="kpi-total-row">
          <td class="kpi-cell"></td>
          <td class="kpi-cell"><div class="kpi-title">Total Downtime Hrs</div><div id="total-downtime" class="kpi-value">--</div></td>
          <td class="kpi-cell"><div class="kpi-title">Total Open Count</div><div id="total-open-count" class="kpi-value">--</div></td>       <!-- NEW -->
          <td class="kpi-cell"><div class="kpi-title">Total Unplanned Count</div><div id="total-unplanned-count" class="kpi-value">--</div></td>
          <td class="kpi-cell"><div class="kpi-title">Total Failure Events</div><div id="total-failure-events" class="kpi-value">--</div></td>
          <td class="kpi-cell"></td>
          <td class="kpi-cell"></td>
          <td class="kpi-cell"></td>
          <td class="kpi-cell"></td>
          <td class="kpi-cell"></td>
        </tr>
      </tfoot>
      </table>
      </div>

  </div>
  <script type="module" src="js/header-kpis.js" defer></script>
  <script>
    const rotateBtn = document.getElementById('toggle-rotation');
    const refreshTimerEl = document.getElementById('refresh-timer');
    const refreshButton  = document.getElementById('refresh-button');
    const refreshInterval = 900000; // 15 minutes
    let refreshCountdown = refreshInterval / 1000;
    let config = {};

    fetch('/config.json')
      .then(r => r.json())
      .then(cfg => { config = cfg; rotatePages(); })
      .catch(() => { config = {}; });

    function updateRotateButton() {
      const paused = localStorage.getItem('rotationPaused') === 'true';
      rotateBtn.textContent = paused ? 'Resume Rotation' : 'Pause Rotation';
      rotateBtn.style.backgroundColor = paused ? 'red' : 'blue';
      rotateBtn.style.color = 'white';
    }
    rotateBtn.addEventListener('click', () => {
      const paused = localStorage.getItem('rotationPaused') === 'true';
      localStorage.setItem('rotationPaused', paused ? 'false' : 'true');
      updateRotateButton();
    });
    updateRotateButton();

    function updateRefreshTimer() {
      const m = Math.floor(refreshCountdown / 60);
      const s = String(refreshCountdown % 60).padStart(2, '0');
      refreshTimerEl.textContent = `Next refresh in ${m}:${s}`;
      refreshCountdown = refreshCountdown > 0 ? refreshCountdown - 1 : refreshInterval / 1000;
    }
    setInterval(updateRefreshTimer, 1000);
    updateRefreshTimer();

    function rotatePages() {
      if (!config.pages) return;
      const page = window.location.pathname.split('/').pop() || 'kpi-by-asset.html';
      const pages = config.pages;
      const interval = config.interval || 15000;
      const next = pages[(pages.indexOf(page) + 1) % pages.length];
      setTimeout(async () => {
                if (await checkBurnIn()) return;
                if (localStorage.getItem('rotationPaused') === 'true') return;
                if (next && next !== page) window.location.href = '/' + next;
            }, interval);
    }

    setInterval(() => { loadByAsset(); refreshCountdown = refreshInterval / 1000; }, refreshInterval);
    refreshButton.addEventListener('click', () => {
     loadByAsset();
     refreshCountdown = refreshInterval / 1000;
   });
    const TF_MAP = {
      currentWeek:     'thisWeek',
      lastWeek:        'lastWeek',
      currentMonth:    'thisMonth',
      lastMonth:       'lastMonth',
      currentYear:     'thisYear',
      lastYear:        'lastYear',
      trailing7Days:   'lastWeek',   // approx until you add a true trailing-7
      trailing30Days:  'last30',     // matches the cache you already compute
      trailing12Months:'lastYear'    // approx until you add a true trailing-12
    };

   async function loadByAsset() {
      // (1) map UI timeframe to API key
      const raw = (document.getElementById('timeframe-select')?.value || 'lastMonth');
      const tf  = TF_MAP[raw] || 'lastMonth';
    
      // (2) fetch
      const res  = await fetch(`/api/kpi/by-asset?tf=${encodeURIComponent(tf)}&t=${Date.now()}`, { cache: 'no-store' });
      const data = await res.json();
      const rows = Array.isArray(data.rows) ? data.rows : [];
    
      // (3) clear table
      const tbody = document.getElementById('kpi-asset-body');
      tbody.innerHTML = '';
      
      // If snapshot has no rows, show dashes and neutral tiles, then stop
      if (!rows.length) {
        // top tiles
        document.querySelector('[data-testid="true-overall-downtime"]').textContent = '--';
        document.querySelector('[data-testid="true-overall-mttr"]').textContent     = '--';
        document.querySelector('[data-testid="true-overall-mtbf"]').textContent     = '--';
        document.querySelector('[data-testid="true-overall-planned"]').textContent  = '--';
        document.querySelector('[data-testid="true-overall-unplanned"]').textContent= '--';
      
        // remove tile colors
        ['tile-downtime','tile-mttr','tile-mtbf','tile-planned','tile-unplanned'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.classList.remove('good','warn','bad');
        });
      
        // new open-count footer cells
        ['avg-open-count','total-open-count'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '--';
        });
      
        // other footer cells
        [
          'total-assets','avg-downtime','avg-unplanned-count','avg-failure-events',
          'avg-downtime-pct','avg-mttr','avg-mtbf','avg-planned','avg-unplanned',
          'total-downtime','total-unplanned-count','total-failure-events'
        ].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '--';
        });
      
        // wipe last refresh / date-range labels
        const lr = document.getElementById('last-refresh'); if (lr) lr.textContent = '';
        const dr = document.getElementById('date-range');   if (dr) dr.textContent = '';
      
        return;
      }
    
      // (5) render table rows
      rows.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.Name ?? r.AssetID}</td>
          <td>${(r.DowntimeHrs ?? 0).toFixed(2)}</td>
          <td>${r.OpenCount ?? 0}</td>
          <td>${r.UnplannedCount ?? 0}</td>
          <td>${r.FailureEvents ?? 0}</td>
          <td>${typeof r.UptimePct === 'number' ? (100 - r.UptimePct).toFixed(1) + '%' : ''}</td>
          <td>${(r.MttrHrs ?? 0).toFixed(2)}</td>
          <td>${(r.MtbfHrs ?? 0).toFixed(2)}</td>
          <td>${(r.PlannedPct ?? 0).toFixed(1)}%</td>
          <td>${(r.UnplannedPct ?? 0).toFixed(1)}%</td>
        `;
        tbody.appendChild(tr);
      });
    
      // (6) totals/averages
      const n  = rows.length;
      const s  = rows.reduce((acc, r) => ({
        downtime:     acc.downtime   + Number(r.DowntimeHrs                || 0),
        sched:        acc.sched      + Number(r.ScheduledHrs               || 0),
        unplannedCnt: acc.unplannedCnt+Number(r.UnplannedCount             || 0),
        plannedCnt:   acc.plannedCnt  + Number(r.PlannedCount               || 0),    
        failEvents:   acc.failEvents  + Number(r.FailureEvents              || 0),
        dtUnplan:     acc.dtUnplan    + Number(r.DowntimeHoursUnplanned     || 0),    
        openCnt:      acc.openCnt     + Number(r.OpenCount                 || 0), 
        // keep these if you still want to show the "Avg of per-asset" table footer
        uptimePctSum: acc.uptimePctSum+ Number(r.UptimePct                 || 0),
        mttrSum:      acc.mttrSum     + Number(r.MttrHrs                   || 0),
        mtbfSum:      acc.mtbfSum     + Number(r.MtbfHrs                   || 0),
        plannedPctSum:acc.plannedPctSum+Number(r.PlannedPct                || 0),
        unplanPctSum: acc.unplanPctSum+ Number(r.UnplannedPct              || 0),
      }), {downtime:0,sched:0,unplannedCnt:0,plannedCnt:0,failEvents:0,dtUnplan:0,openCnt:0,
          uptimePctSum:0,mttrSum:0,mtbfSum:0,plannedPctSum:0,unplanPctSum:0});
      
      // (7) True Overall (global)
      const overallDowntimePct = s.sched > 0 ? (s.downtime / s.sched) * 100
                                             : (100 - (s.uptimePctSum / n)); // fallback only
      const totalEvents = s.plannedCnt + s.unplannedCnt;
      const overallPlannedPct   = totalEvents > 0 ? (s.plannedCnt   / totalEvents) * 100 : 0;
      const overallUnplannedPct = totalEvents > 0 ? (s.unplannedCnt / totalEvents) * 100 : 0;
      const overallMttr = s.failEvents > 0 ? (s.dtUnplan / s.failEvents) : 0;
      const overallMtbf = s.failEvents > 0 ? ((s.sched - s.downtime) / s.failEvents) : 0;
      
      // (8) bind tiles (use global, not averages)
      document.querySelector('[data-testid="true-overall-downtime"]').textContent = overallDowntimePct.toFixed(1) + '%';
      document.querySelector('[data-testid="true-overall-mttr"]').textContent      = overallMttr.toFixed(2);
      document.querySelector('[data-testid="true-overall-mtbf"]').textContent      = overallMtbf.toFixed(2);
      document.querySelector('[data-testid="true-overall-planned"]').textContent   = overallPlannedPct.toFixed(1) + '%';
      document.querySelector('[data-testid="true-overall-unplanned"]').textContent = overallUnplannedPct.toFixed(1) + '%';

      // (9) paint tiles with thresholds (use the overall* values)
      const t = {
        downtimePct: { goodMax: 10.0,  warnMax: 20.0 },
        mttr:        { goodMax: 4.0,   warnMax: 8.0  },
        mtbf:        { goodMin: 108.0, warnMin: 72.0 },
        plannedPct:  { goodMin: 70.0,  warnMin: 50.0 },
        unplannedPct:{ goodMax: 30.0,  warnMax: 50.0 }
      };

      function paintMax(el, v, {goodMax, warnMax}) {
        el.classList.remove('good','warn','bad');
        el.classList.add(v <= goodMax ? 'good' : v <= warnMax ? 'warn' : 'bad');
      }
      function paintMin(el, v, {goodMin, warnMin}) {
        el.classList.remove('good','warn','bad');
        el.classList.add(v >= goodMin ? 'good' : v >= warnMin ? 'warn' : 'bad');
      }

      paintMax(document.getElementById('tile-downtime'),  overallDowntimePct,   t.downtimePct);
      paintMax(document.getElementById('tile-mttr'),      overallMttr,          t.mttr);
      paintMin(document.getElementById('tile-mtbf'),      overallMtbf,          t.mtbf);
      paintMin(document.getElementById('tile-planned'),   overallPlannedPct,    t.plannedPct);
      paintMax(document.getElementById('tile-unplanned'), overallUnplannedPct,  t.unplannedPct);

      // (10) footer totals/averages (show overall values to match header)
      document.getElementById('total-assets').textContent           = n;
      document.getElementById('avg-downtime').textContent           = (s.downtime / n).toFixed(2);
      document.getElementById('avg-unplanned-count').textContent    = (s.unplannedCnt / n).toFixed(2);
      document.getElementById('avg-failure-events').textContent     = (s.failEvents / n).toFixed(2);
      document.getElementById('avg-open-count').textContent      = (s.openCnt      / n).toFixed(2);
      document.getElementById('avg-downtime-pct').textContent       = overallDowntimePct.toFixed(1) + '%';
      document.getElementById('avg-mttr').textContent               = overallMttr.toFixed(2);
      document.getElementById('avg-mtbf').textContent               = overallMtbf.toFixed(2);
      document.getElementById('avg-planned').textContent            = overallPlannedPct.toFixed(1) + '%';
      document.getElementById('avg-unplanned').textContent          = overallUnplannedPct.toFixed(1) + '%';

      document.getElementById('total-downtime').textContent         = s.downtime.toFixed(2);
      document.getElementById('total-unplanned-count').textContent  = s.unplannedCnt;
      document.getElementById('total-failure-events').textContent   = s.failEvents;
      document.getElementById('total-open-count').textContent      = s.openCnt;
    
      // (11) last refresh + date range
      const lr = document.getElementById('last-refresh');
      if (lr && data.lastRefreshUtc) {
        lr.textContent = '· Last refresh: ' + new Date(data.lastRefreshUtc)
          .toLocaleString('en-US', { timeZone: 'America/Indiana/Indianapolis' });
      }
      const dr = document.getElementById('date-range');
      if (dr && data.range) {
        const rs = new Date(data.range.start);
        const re = new Date(new Date(data.range.end).getTime() - 24*3600*1000); // exclusive → inclusive
        dr.textContent = `${rs.toLocaleDateString('en-US',{timeZone:'America/Indiana/Indianapolis'})} — ${re.toLocaleDateString('en-US',{timeZone:'America/Indiana/Indianapolis'})}`;
      }
    }

   // run once on load
  loadByAsset();  
  // manual refresh + react to timeframe changes
  document.getElementById('refresh-button').addEventListener('click', loadByAsset);
  document.getElementById('timeframe-select').addEventListener('change', loadByAsset);
  </script>
  <script>
    // clock
    function updateClock() {
      const now = new Date();
      const dateFmt = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/Indiana/Indianapolis',
        weekday:'short', month:'short', day:'numeric', year:'numeric'
      });
      const timeFmt = new Intl.DateTimeFormat('en-US', {
        timeZone: 'America/Indiana/Indianapolis',
        hour:'numeric', minute:'2-digit', second:'2-digit'
      });
      document.getElementById('clock').innerHTML =
        `<span class="clock-date">${dateFmt.format(now)}</span>${timeFmt.format(now)}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

  </script>
  <script>
  function isoLastWeekRangeUTC(now = new Date()) {
    // force UTC midnight for consistency
    const n = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    const dow = n.getUTCDay();                       // 0..6 (Sun..Sat)
    const monOffset = (dow + 6) % 7;                 // days since Monday
    const thisMon = new Date(n); thisMod = thisMon.setUTCDate(n.getUTCDate() - monOffset);
    const lastMon = new Date(thisMon); lastMon.setUTCDate(thisMon.getUTCDate() - 7);
    const lastSun = new Date(thisMon); lastSun.setUTCDate(thisMon.getUTCDate() - 1);
    return { start: new Date(lastMon), end: new Date(lastSun) };  // label: Mon..Sun
  }
  
  function lastMonthRangeUTC(now = new Date()) {
    const y = now.getUTCFullYear(), m = now.getUTCMonth();
    const start = new Date(Date.UTC(y, m - 1, 1));
    const end   = new Date(Date.UTC(y, m, 0)); // last day of prior month
    return { start, end };
  }
  
  </script>

</body>
</html>
