<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>KPIs by Asset</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="css/style.css">
  <script src="burnin.js" defer></script>
</head>
<body>
<main>
  <h1>KPIs by Asset <small id="kpi-range" style="font-weight:normal;font-size:0.9rem;color:#555;"></small></h1>
  <div style="margin:8px 0;">
    <label>Timeframe:
      <select id="tf-select">
        <option value="lastMonth">Last Month</option>
        <option value="last30">Last 30 Days</option>
        <option value="lastWeek">Last Week</option>
      </select>
    </label>
  </div>
  <table>
    <thead>
      <tr>
        <th>Asset</th>
        <th>Downtime %</th>
        <th>Downtime (h)</th>
        <th>MTTR (h)</th>
        <th>MTBF (h)</th>
        <th>Planned %</th>
        <th>Unplanned %</th>
      </tr>
    </thead>
    <tbody id="kpi-by-asset-body"></tbody>
  </table>
</main>
<script>
  async function loadKpis(tf) {
    const res = await fetch(`/api/kpis/by-asset?timeframe=${encodeURIComponent(tf)}`, { cache: 'no-store' });
    const data = await res.json();
    const assets = data.assets || {};
    const ids = Object.keys(assets);
    const tbody = document.getElementById('kpi-by-asset-body');
    tbody.innerHTML = '';
    if (!ids.length) {
      console.warn('[kpi-by-asset] no rows for', tf);
      return;
    }
    ids.forEach(id => {
      const a = assets[id];
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.name}</td>
        <td>${a.downtimePct ?? ''}%</td>
        <td>${a.DowntimeHrs ?? ''}</td>
        <td>${a.MttrHrs ?? ''}</td>
        <td>${a.MtbfHrs ?? ''}</td>
        <td>${a.PlannedPct ?? ''}%</td>
        <td>${a.UnplannedPct ?? ''}%</td>
      `;
      tbody.appendChild(tr);
    });
    const rangeEl = document.getElementById('kpi-range');
    if (rangeEl && data.range) {
      rangeEl.textContent = `Range: ${new Date(data.range.start).toLocaleDateString()} â€“ ${new Date(data.range.end).toLocaleDateString()}`;
    }
  }
  (async () => {
    try {
      const cfg = await fetch('/config.json').then(r=>r.json()).catch(()=>({}));
      const tf = cfg.kpiByAssetDefaultTimeframe || 'lastMonth';
      const tfSel = document.getElementById('tf-select');
      if (tfSel) tfSel.value = tf;
      await loadKpis(tf);
      tfSel?.addEventListener('change', e => loadKpis(e.target.value));
    } catch(e) {
      console.error('[kpi-by-asset] init error', e);
    }
  })();
</script>
</body>
</html>
