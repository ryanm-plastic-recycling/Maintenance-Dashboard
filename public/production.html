<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Production Data</title>
  <style>
    :root{
      --pri-blue:#25408F; --pri-green:#92D050; --bg:#E9EDF5; --card:#FBFCFE; --ink:#0F172A; --muted:#475569;
      --ok:#11A85B; --warn:#F59E0B; --bad:#D32F2F;
      --ok-bg:#dcfce7; --warn-bg:#fef9c3; --bad-bg:#fee2e2;
      --border:#D7E0F3;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}

    /* Header */
    .top-border{position:fixed;top:0;left:0;width:100%;height:96px;background:var(--pri-green);z-index:10;display:flex;align-items:center;padding:0 20px}
    .top-border .logo{height:72px}
    .top-title{font-size:28px;font-weight:900;margin-left:20px;color:#0A2A12}
    .tabs{margin-left:auto;display:flex;gap:8px}
    .tab{background:#ffffffd9;padding:8px 12px;border-radius:10px;text-decoration:none;color:#0A2A12;font-weight:700}
    .tab.active{background:#fff}

    /* Page */
    .wrap{margin:120px 20px 40px 20px}
    .controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:0 0 16px}
    .meta-range{color:var(--muted);font-size:13px}

    /* Overall KPI tiles */
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;margin-top:6px}
    .tile{background:var(--card);padding:10px 12px;border-radius:12px;box-shadow:0 2px 4px rgba(0,0,0,.08);border:1px solid var(--border);text-align:center;min-height:70px}
    .tile .lab{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
    .tile .val{font-size:22px;font-weight:900;margin-top:4px}
    .tile.good{background:var(--ok-bg)} .tile.warn{background:var(--warn-bg)} .tile.bad{background:var(--bad-bg)}

    /* graded line tiles */
    .lt-card.good  { background: #ecfdf5; border-color: #10b98120; }
    .lt-card.warn  { background: #fffbeb; border-color: #f59e0b20; }
    .lt-card.bad   { background: #fef2f2; border-color: #ef444420; }
    
    /* gauge colors */
    .gauge .pct { font-size: 18px; font-weight: 800; }
    .gauge.good  .needle { stroke: #10b981; }  /* green */
    .gauge.warn  .needle { stroke: #f59e0b; }  /* amber */
    .gauge.bad   .needle { stroke: #ef4444; }  /* red  */
    
    .gauge .track { stroke: #e5e7eb; }         /* light gray track */
    .gauge .cap   { font-size: 11px; color: var(--muted); text-align: center; margin-top: -4px; }
    .lt-right { gap: 8px; }  /* a bit tighter */

    /* Two-column layout (line tiles + heatmap) */
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
    @media (max-width:1100px){ .grid{grid-template-columns:1fr} }

    .card{background:var(--card);border-radius:12px;border:1px solid var(--border);box-shadow:0 2px 6px rgba(0,0,0,.1);padding:12px}
    .card h3{margin:0 0 8px;font-size:18px;color:var(--pri-blue);display:flex;align-items:center;gap:8px}
    .card .sub{font-size:12px;color:var(--muted);font-weight:600}

    /* LINE TILES */
    .line-tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:10px}
    .lt-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:10px;display:grid;grid-template-columns:1fr 140px;gap:10px}
    .lt-head{display:flex;align-items:baseline;justify-content:space-between}
    .lt-name{font-weight:900}
    .lt-nameplate{font-size:12px;color:var(--muted)}
    .lt-badges{display:flex;gap:6px;margin-top:6px}
    .badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800;border:1px solid #0001}
    .badge.maint{background:#FEE8A6;color:#3B2F0A}
    .badge.prod {background:#DBE6FF;color:#0D246F}
    .lt-metrics{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
    .m{background:#f7fafc;border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center}
    .m .lab{font-size:11px;color:var(--muted)}
    .m .val{font-weight:900}
    .good.m{background:var(--ok-bg)} .warn.m{background:var(--warn-bg)} .bad.m{background:var(--bad-bg)}
    .lt-right{display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center}

    /* simple “speedo” gauge */
    .speedo{width:120px;height:70px}
    .speedo .cap{font-size:11px;color:var(--muted);text-align:center;margin-top:-4px}

    /* HEATMAP table */
    table{width:100%;border-collapse:collapse;margin-top:6px}
    th,td{padding:8px;border-bottom:1px solid #E1E9F8;text-align:center}
    th{background:var(--pri-blue);color:#fff;font-size:13px;position:sticky;top:0}
    td.line{text-align:left;font-weight:700}
    .good{background:var(--ok-bg)} .warn{background:var(--warn-bg)} .bad{background:var(--bad-bg)}

    /* CHART section */
    .chart-section{margin-top:16px}
    .chart-container{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
    .chart-container h2{margin:0 0 6px;color:var(--pri-blue);display:flex;gap:8px;align-items:center}
    .chart-container .sub{font-size:12px;color:var(--muted);font-weight:600}
    .chart{background:linear-gradient(180deg,#F7F9FF,#EEF3FF);border:1px solid var(--border);border-radius:10px;padding:6px}
    .chart svg{width:100%;height:260px;display:block}
  </style>
</head>
<body>
  <div class="top-border">
    <img src="img/pri-logo.png" alt="PRI Logo" class="logo" />
    <div class="top-title">Production Data</div>
    <div class="tabs">
      <a class="tab" href="index.html">Work Orders</a>
      <a class="tab" href="pm.html">PM</a>
      <a class="tab" href="prodstatus.html">Prod Status</a>
      <a class="tab" href="kpi-by-asset.html">KPIs by Asset</a>
      <a class="tab active" href="#">Production</a>
      <a class="tab" href="admin">Admin</a>
    </div>
  </div>

  <div class="wrap">
    <div class="controls">
      <span class="meta-range">Timeframe: <strong>Last 30 days</strong> (Weekdays only; Shifts A/B/C)</span>
    </div>

    <!-- OVERALL KPIs -->
    <section>
      <h2>Overall KPIs <span class="sub">(Last 30 days)</span></h2>
      <div class="kpis">
        <div class="tile good"><div class="lab">OEE</div><div class="val" id="ov-oee">--%</div></div>
        <div class="tile good"><div class="lab">Availability</div><div class="val" id="ov-av">--%</div></div>
        <div class="tile"><div class="lab">Performance (Raw 24h)</div><div class="val" id="ov-pr">--%</div></div>
        <div class="tile"><div class="lab">Performance (Adj for DT)</div><div class="val" id="ov-pa">--%</div></div>
        <div class="tile"><div class="lab">Total Pounds</div><div class="val" id="ov-lbs">--</div></div>
        <div class="tile"><div class="lab">Maint DT (h)</div><div class="val" id="ov-mdt">--</div></div>
        <div class="tile"><div class="lab">Prod DT (h)</div><div class="val" id="ov-pdt">--</div></div>
      </div>
    </section>

    <!-- LINE TILES + HEATMAP -->
    <section class="grid">
      <div class="card">
        <h3>Line Tiles <span class="sub">(Lines 1–9 • Last 30 days)</span></h3>
        <div id="lineTiles" class="line-tiles"></div>
      </div>

      <div class="card">
        <h3>Weekday OEE Heatmap <span class="sub">(Last 30 days)</span></h3>
        <table id="heat"></table>
      </div>
    </section>

    <!-- RENDERED CHART -->
    <section class="chart-section">
      <div class="chart-container">
        <h2>Production Trend <span class="sub">(Last 30 days)</span></h2>
        <div class="chart"><div id="trendChart"></div></div>
      </div>
    </section>
  </div>

<script>
(async function () {
  // --- helpers ---
  const qs = s => document.querySelector(s);
  const fmtPct = v => (v == null ? '0%' : (v*100).toFixed(0) + '%');
  const fmtNum = v => (v == null ? '0' : Number(v).toLocaleString());
  const isWeekday = d => { const n = d.getDay(); return n !== 0 && n !== 6; };

  const today = new Date();
  const to   = today.toISOString().slice(0,10);
  const fromD = new Date(today); fromD.setDate(fromD.getDate() - 29); // 30-day window
  const from = fromD.toISOString().slice(0,10);

  // build full date list (weekdays only to match your assumption)
  const dates = [];
  for (let d = new Date(fromD); d <= today; d.setDate(d.getDate()+1)) {
    if (isWeekday(d)) dates.push(new Date(d).toISOString().slice(0,10));
  }

  // --- fetch from API ---
  const [summaryRaw, bylineRaw] = await Promise.all([
    fetch(`/api/production/summary?from=${from}&to=${to}`).then(r=>r.json()),
    fetch(`/api/production/by-line?from=${from}&to=${to}`).then(r=>r.json())
  ]);

  // keep extruders only
  const byline = (bylineRaw || []).filter(r => r.machine && r.machine.startsWith('Extruder'));
  const summary = summaryRaw || [];

  // --- fill missing dates with zeros (overall) ---
  const summaryByDate = new Map(summary.map(r => [r.src_date, r]));
  const overall = dates.map(d => {
    const r = summaryByDate.get(d);
    return {
      src_date: d,
      pounds: r?.pounds ?? 0,
      availability: r?.availability ?? 0,
      perf_adj: r?.perf_adj ?? 0,
      oee: r?.oee ?? 0
    };
  });

  // --- overall tiles (use last day in filled series) ---
  const last = overall[overall.length-1] || { pounds:0, availability:0, perf_adj:0, oee:0 };
  const totalLbs = overall.reduce((s,x)=>s+(x.pounds||0),0);
  // For DT totals across extruders in range:
  const dtAgg = byline.reduce((a,r)=>({m:a.m+(r.maint_dt_h||0), p:a.p+(r.prod_dt_h||0)}), {m:0,p:0});

  qs('#ov-oee').textContent = fmtPct(last.oee);
  qs('#ov-av').textContent  = fmtPct(last.availability);
  qs('#ov-pr').textContent  = fmtPct(last.perf_adj);      // using adj perf in both tiles per your preference
  qs('#ov-pa').textContent  = fmtPct(last.perf_adj);
  qs('#ov-lbs').textContent = fmtNum(totalLbs);
  qs('#ov-mdt').textContent = (dtAgg.m).toFixed(1);
  qs('#ov-pdt').textContent = (dtAgg.p).toFixed(1);

  // --- latest per extruder line (most recent date in window) ---
  const latestByLine = {};
  for (const r of byline) {
    if (!latestByLine[r.machine] || r.src_date > latestByLine[r.machine].src_date) {
      latestByLine[r.machine] = r;
    }
  }
  const cont = document.getElementById('lineTiles'); cont.innerHTML = '';
  Object.values(latestByLine)
  .sort((a,b)=>a.machine.localeCompare(b.machine))
  .forEach(r => {
    const cap  = r.nameplate_lbs_hr || 0;
    const lbs  = r.pounds || 0;
    const dt   = (r.maint_dt_h||0) + (r.prod_dt_h||0);
    const avail = r.availability ?? 0;

    const perfRaw = cap ? (lbs / (24 * cap)) : 0;
    const perfAdj = r.perf_adj ?? (cap && (24 - dt) > 0 ? lbs / (cap * (24 - dt)) : 0);
    const oee     = r.oee ?? (avail * perfAdj);  // quality=1.0 for now

    const tileGrade = grade(oee, THRESH.oee);
    const rawGrade  = grade(perfRaw, THRESH.capacityAdj);
    const adjGrade  = grade(perfAdj, THRESH.capacityAdj);

    const el = document.createElement('div');
    el.className = `lt-card ${tileGrade}`;
    el.innerHTML = `
      <div>
        <div class="lt-head">
          <div class="lt-name">${r.machine}</div>
          <div class="lt-nameplate">Nameplate ${cap?cap.toLocaleString():'--'} lb/hr</div>
        </div>
        <div class="lt-badges">
          <span class="badge maint">Maint DT ${(r.maint_dt_h||0).toFixed(1)}h</span>
          <span class="badge prod">Prod DT ${(r.prod_dt_h||0).toFixed(1)}h</span>
        </div>
        <div class="lt-metrics" style="margin-top:6px">
          <div class="m"><div class="lab">OEE</div><div class="val">${(oee*100).toFixed(0)}%</div></div>
          <div class="m"><div class="lab">Availability</div><div class="val">${(avail*100).toFixed(0)}%</div></div>
          <div class="m"><div class="lab">Perf Raw</div><div class="val">${(perfRaw*100).toFixed(0)}%</div></div>
          <div class="m"><div class="lab">Perf Adj</div><div class="val">${(perfAdj*100).toFixed(0)}%</div></div>
          <div class="m"><div class="lab">Pounds</div><div class="val">${(lbs||0).toLocaleString()}</div></div>
          <div class="m"><div class="lab">Capacity</div><div class="val">${cap?cap.toLocaleString():'--'}</div></div>
        </div>
      </div>

      <div class="lt-right">
        ${gaugeSVG(perfRaw, 'Raw 24h', rawGrade)}
        ${gaugeSVG(perfAdj, 'Adj for DT', adjGrade)}
      </div>`;
    cont.appendChild(el);
  });
  Object.values(latestByLine)
    .sort((a,b)=>a.machine.localeCompare(b.machine))
    .forEach(r => {
      const cap  = r.nameplate_lbs_hr || 0;
      const lbs  = r.pounds || 0;
      const dt   = (r.maint_dt_h||0) + (r.prod_dt_h||0);
      const avail = r.availability ?? 0;
  
      const perfRaw = cap ? (lbs / (24 * cap)) : 0;
      const perfAdj = r.perf_adj ?? (cap && (24 - dt) > 0 ? lbs / (cap * (24 - dt)) : 0);
      const oee     = r.oee ?? (avail * perfAdj);  // quality=1.0 for now
  
      const tileGrade = grade(oee, THRESH.oee);
      const rawGrade  = grade(perfRaw, THRESH.capacityAdj);
      const adjGrade  = grade(perfAdj, THRESH.capacityAdj);
  
      const el = document.createElement('div');
      el.className = `lt-card ${tileGrade}`;
      el.innerHTML = `
        <div>
          <div class="lt-head">
            <div class="lt-name">${r.machine}</div>
            <div class="lt-nameplate">Nameplate ${cap?cap.toLocaleString():'--'} lb/hr</div>
          </div>
          <div class="lt-badges">
            <span class="badge maint">Maint DT ${(r.maint_dt_h||0).toFixed(1)}h</span>
            <span class="badge prod">Prod DT ${(r.prod_dt_h||0).toFixed(1)}h</span>
          </div>
          <div class="lt-metrics" style="margin-top:6px">
            <div class="m"><div class="lab">OEE</div><div class="val">${(oee*100).toFixed(0)}%</div></div>
            <div class="m"><div class="lab">Availability</div><div class="val">${(avail*100).toFixed(0)}%</div></div>
            <div class="m"><div class="lab">Perf Raw</div><div class="val">${(perfRaw*100).toFixed(0)}%</div></div>
            <div class="m"><div class="lab">Perf Adj</div><div class="val">${(perfAdj*100).toFixed(0)}%</div></div>
            <div class="m"><div class="lab">Pounds</div><div class="val">${(lbs||0).toLocaleString()}</div></div>
            <div class="m"><div class="lab">Capacity</div><div class="val">${cap?cap.toLocaleString():'--'}</div></div>
          </div>
        </div>
  
        <div class="lt-right">
          ${gaugeSVG(perfRaw, 'Raw 24h', rawGrade)}
          ${gaugeSVG(perfAdj, 'Adj for DT', adjGrade)}
        </div>`;
      cont.appendChild(el);
    });

  // --- simple trend (overall lbs vs capacity) with zero-filled dates ---
  (function renderTrend(){
    const w=900,h=260,padL=50,padB=30, ch=h-padB-40;
    const sx=i => padL + (i/Math.max(1,overall.length-1))*(w-padL-20);
    const sy=v => 30 + ch - (v/max)*ch;

    // Build “capacity” lines from byline extruders per day
    const byDate = new Map();
    for (const d of dates) byDate.set(d, { lbs:0, nameplate:0, adjcap:0 });
    for (const r of byline) {
      const d = r.src_date; if (!byDate.has(d)) continue;
      const cap = r.nameplate_lbs_hr || 0;
      const lbs = r.pounds || 0;
      const dt  = (r.maint_dt_h||0)+(r.prod_dt_h||0);
      byDate.get(d).lbs      += lbs;
      byDate.get(d).nameplate+= cap*24;
      byDate.get(d).adjcap   += cap*Math.max(0, 24 - dt);
    }
    const pts = dates.map(d => byDate.get(d));
    const max = Math.max(1, ...pts.map(p => Math.max(p.lbs, p.nameplate, p.adjcap)));

    const toLine = arr => arr.map((p,i)=>`${sx(i)},${sy(p)}`).join(' ');
    const lbsPts  = toLine(pts.map(p=>p.lbs));
    const namePts = toLine(pts.map(p=>p.nameplate));
    const adjPts  = toLine(pts.map(p=>p.adjcap));

    let grid=''; for(let i=0;i<=4;i++){ const y=30+(i/4)*ch;
      grid += `<line x1="${padL}" y1="${y}" x2="${w-20}" y2="${y}" stroke="#D7E0F3" stroke-width="1" opacity="0.7"/>`;
    }
    const xlabels = dates.map((d,i)=>`<text x="${sx(i)}" y="${h-10}" text-anchor="middle" fill="#475569" font-size="12">${d.slice(5)}</text>`).join('');

    const svg = `<svg viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg">
      <rect x="0" y="0" width="100%" height="100%" fill="#F7F9FF"/>
      ${grid}
      <polyline fill="none" stroke="#22c55e" stroke-width="3" points="${namePts}"/>
      <polyline fill="none" stroke="#f59e0b" stroke-width="3" points="${adjPts}"/>
      <polyline fill="none" stroke="#2563eb" stroke-width="3" points="${lbsPts}"/>
      ${xlabels}
    </svg>`;
    document.getElementById('trendChart').innerHTML = svg;
  })();

})();
</script>
<script>
/* thresholds already defined in your page; reuse them */
const grade = (v, {good, warn}) => (v >= good ? 'good' : v >= warn ? 'warn' : 'bad');

/* SVG arc util (draw from 180° down to end angle, CCW) */
function polarToCartesian(cx, cy, r, angDeg) {
  const a = (angDeg - 90) * Math.PI / 180;
  return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
}
function arcPath(cx, cy, r, startDeg, endDeg) {
  const s = polarToCartesian(cx, cy, r, startDeg);
  const e = polarToCartesian(cx, cy, r, endDeg);
  const largeArc = Math.abs(endDeg - startDeg) > 180 ? 1 : 0;
  /* sweep-flag=0 (counter-clockwise), so we never “flip” the arc off the card */
  return `M ${s.x} ${s.y} A ${r} ${r} 0 ${largeArc} 0 ${e.x} ${e.y}`;
}

/* Gauge: pct in [0..1], label below. Two-layer arc: light track + colored needle */
function gaugeSVG(pct, label, cls = '') {
  const p = Math.max(0, Math.min(1, pct || 0));
  const start = 180, end = 180 - 180 * p;   // 180° (left) down to end
  const R = 48, cx = 60, cy = 60;

  const track = arcPath(cx, cy, R, 180, 0);
  const needle = arcPath(cx, cy, R, start, end);

  return `
    <div class="gauge ${cls}">
      <svg viewBox="0 0 120 80" xmlns="http://www.w3.org/2000/svg" class="speedo">
        <path d="${track}" class="track" fill="none" stroke-width="10"/>
        <path d="${needle}" class="needle" fill="none" stroke-width="10" stroke-linecap="round"/>
        <text x="60" y="48" text-anchor="middle" class="pct">${Math.round(p*100)}%</text>
      </svg>
      <div class="cap">${label}</div>
    </div>`;
}
</script>

</body>
</html>
