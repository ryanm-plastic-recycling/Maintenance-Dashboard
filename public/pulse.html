<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRI Pulse</title>
  <style>
    :root{
      --pri-blue:#25408F; --pri-green:#92D050;
      --bg:#E9EDF5; --card:#FBFCFE; --ink:#0F172A; --muted:#475569; --border:#D7E0F3;
      --good-bg:#dcfce7;  --good-fg:#065f46;
      --warn-bg:#fef9c3;  --warn-fg:#7c5e10;
      --bad-bg:#fee2e2;   --bad-fg:#7f1d1d;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --chip:#f7fafc;
    }
    *{box-sizing:border-box}

    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .page-production::before{
      content:"";position:fixed;inset:0;z-index:-1;
      background:
        linear-gradient(to bottom, rgba(255,255,255,.75), rgba(255,255,255,.85)),
        url('img/PRIfront.png') center/cover no-repeat fixed;
    }

    /* Header (match production.html) */
    .top-border{position:fixed;top:0;left:0;width:100%;height:96px;background:var(--pri-green);z-index:10;display:flex;align-items:center;padding:0 20px}
    .top-border .logo{height:72px}
    .top-title{font-size:28px;font-weight:900;margin-left:20px;color:#0A2A12}
    .tabs{margin-left:auto;display:flex;gap:8px;align-items:center}
    .tab{background:#ffffffd9;padding:8px 12px;border-radius:10px;text-decoration:none;color:#0A2A12;font-weight:700}
    .tab.active{background:#fff}
    .wrap{margin:120px 20px 40px 20px}

    /* Loading overlay spinner */
    #loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.55);z-index:9999}
    #loading .spinner{width:64px;height:64px;border:8px solid #e5e7eb;border-top-color:var(--pri-blue);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .app{max-width:1920px;margin:0 auto}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:10px 0 16px;gap:10px;flex-wrap:wrap}
    .left,.right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .segBig{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card);box-shadow:var(--shadow)}
    .segBig button{border:0;background:transparent;padding:8px 12px;font-weight:700;color:var(--muted);cursor:pointer}
    .segBig button.active{background:var(--pri-blue);color:white}
    .pill{padding:6px 10px;border-radius:999px;background:white;border:1px solid var(--border);color:var(--muted);font-weight:700}

    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:12px}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 16px;box-shadow:var(--shadow);min-height:90px}
    .kpi .label{font-size:12px;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.6px}
    .kpi .value{font-size:32px;font-weight:900;margin-top:6px}
    .kpi.good{background:var(--good-bg);color:var(--good-fg);border-color:#bbf7d0}
    .kpi.warn{background:var(--warn-bg);color:var(--warn-fg);border-color:#fde68a}
    .kpi.bad{ background:var(--bad-bg); color:var(--bad-fg); border-color:#fecaca}

    .statusbar{display:flex;gap:10px;overflow:auto;padding:8px 2px;margin-bottom:14px}
    .chip{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);white-space:nowrap}
    .dot{width:12px;height:12px;border-radius:50%}
    .st-available{background:#16a34a}
    .st-setup{background:#f59e0b}
    .st-downm{background:#ef4444}
    .st-downp{background:#dc2626}

    /* Grid + cards */
    .grid{display:grid;grid-template-columns:420px 1fr;gap:16px;align-items:stretch}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px;letter-spacing:.3px;color:var(--muted)}
    .card .content{padding:14px}

    /* Donuts kept visible (placeholder ok) */
    .donutwrap{display:grid;grid-template-columns:1fr;gap:12px}
    .donutrow{display:grid;grid-template-columns:160px 1fr;gap:12px;align-items:center}
    .legend{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .legend .row{display:flex;align-items:center;gap:8px}
    .legend .name{max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* Line tiles responsive with clean scaling */
    .lines{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:12px}
    .line{border:1px solid var(--border);border-radius:14px;padding:12px;background:white;display:flex;flex-direction:column}
    .lineheader{display:flex;justify-content:space-between;align-items:center}
    .linename{font-weight:900}
    .badge{font-size:12px;font-weight:900;padding:4px 8px;border-radius:999px}
    .badge.good{background:var(--good-bg);color:var(--good-fg);border:1px solid #bbf7d0}
    .badge.warn{background:var(--warn-bg);color:var(--warn-fg);border:1px solid #fde68a}
    .badge.bad{ background:var(--bad-bg); color:var(--bad-fg); border:1px solid #fecaca}
    .metricrow{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:8px}
    .mitem{background:#f7fafc;border:1px solid var(--border);border-radius:10px;padding:8px;min-width:0}
    .mitem .mkv{font-size:22px;font-weight:900}
    .spark{width:100%;height:40px;margin-top:6px}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px dashed var(--border)}
    th{text-align:left;color:var(--muted);font-weight:900}

    footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted)}
    .clock{font-variant-numeric:tabular-nums;font-weight:900}

    @media (min-width:2560px){
      .app{max-width:2560px}
      .kpi .value{font-size:46px}
      .kpi .label, .badge{font-size:16px}
      .spark{height:54px}
      .lines{gap:18px}
      .line{padding:16px}
      table{font-size:18px}
    }
  </style>
</head>

<body class="page-production">
  <!-- Spinner -->
  <div id="loading"><div class="spinner" aria-label="Loading‚Ä¶"></div></div>

  <div class="top-border">
    <img src="img/pri-logo.png" alt="PRI Logo" class="logo" />
    <div class="top-title">PRI Pulse <span id="periodLabel" style="font-size:16px;font-weight:800;margin-left:8px;color:#0A2A12"></span></div>
    <div class="tabs">
      <a class="tab" href="index.html">Work Orders</a>
      <a class="tab" href="pm.html">PM</a>
      <a class="tab" href="prodstatus.html">Prod Status</a>
      <a class="tab" href="kpi-by-asset.html">KPIs by Asset</a>
      <a class="tab" href="production.html">Transformation</a>
      <a class="tab active" href="pulse.html">Pulse</a>
      <a class="tab" href="admin">Admin</a>
      <!-- no white box; scale to header height -->
      <img src="img/innovation-logo.png" alt="Innovation" style="height:72px;margin-left:8px;object-fit:contain"/>
    </div>
  </div>

  <div class="wrap">
    <div class="app" id="app">

      <div class="toolbar">
        <div class="left">
          <div class="segBig" role="tablist" aria-label="Timeframe">
            <button data-period="today" role="tab">Today</button>
            <button data-period="yesterday" role="tab">Yesterday</button>
            <button data-period="week" role="tab">This Week</button>
            <button data-period="lastweek" class="active" role="tab">Last Week</button>
            <button data-period="month" role="tab">This Month</button>
            <button data-period="lastmonth" role="tab">Last Month</button>
            <button data-period="r7" role="tab">Rolling 7d</button>
            <button data-period="r30" role="tab">Rolling 30d</button>
          </div>
          <span class="pill" id="sitePill">All Sites</span>
        </div>
        <div class="right">
          <span class="pill">Auto-refresh: <strong id="refreshSec">60s</strong></span>
          <span class="pill">Press <strong>F</strong> for Fullscreen</span>
        </div>
      </div>

      <!-- STATUS TICKER -->
      <!-- <div class="statusbar" id="statusBar"></div> -->

      <!-- KPI STRIP -->
      <section class="kpis" id="kpiStrip"></section>

      <section class="grid">
        <!-- Left: Downtime pies (placeholder OK) -->
        <article class="card">
          <h3>Downtime Overview ‚Äî Maintenance vs Production</h3>
          <div class="content donutwrap">
            <div class="donutrow">
              <canvas id="donutMaint" width="160" height="160"></canvas>
              <div><div class="legend" id="legendMaint"></div></div>
            </div>
            <div class="donutrow">
              <canvas id="donutProd" width="160" height="160"></canvas>
              <div><div class="legend" id="legendProd"></div></div>
            </div>
          </div>
        </article>

        <!-- Right: Line health -->
        <article class="card">
          <h3>Line Health (OEE / Avail / Perf / Quality)</h3>
          <div class="content">
            <div class="lines" id="linesGrid"></div>
          </div>
        </article>
      </section>

      <!-- Bottom row -->
      <section class="grid" style="margin-top:16px">
        <article class="card">
          <h3>Production Line Status</h3>
          <div class="content" id="prodStatusList"></div>
        </article>
        <article class="card">
          <h3>Lines Ranked by OEE & Missed Opportunity</h3>
          <div class="content">
            <table id="rankTable">
              <thead>
                <tr><th style="width:28%">Line</th><th style="width:14%">OEE %</th><th style="width:22%">Pounds</th><th>Missed Opp (lb)</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </article>
      </section>

      <footer>
        <div>Last updated <span id="updated"></span></div>
        <div class="clock" id="clock"></div>
      </footer>

    </div>
  </div>

<script>
/* ===== endpoints ===== */
const ENDPOINTS = {
  SUMMARY   : '/api/production/summary',
  BY_LINE   : '/api/production/by-line',
  PRODSTATUS: '/api/workorders/prodstatus',
  MAP       : 'mappings.json'
};
const HOURS_PER_DAY = 24;
const QUALITY_DEFAULT = 0.70;  // match production

/* thresholds */
const classForKPI     = v => v>=70? 'good' : v>=50? 'warn':'bad';
const classForQuality = v => v>=98? 'good' : v>=85? 'warn' : 'bad';

const $   = s => document.querySelector(s);
const fmt = n => Number(Math.round(n||0)).toLocaleString();

/* spinner + fetch */
function setLoading(v){ const el=$('#loading'); if(el) el.style.display = v ? 'flex':'none'; }
async function fetchJSON(url){
  try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return await r.json(); }
  catch(e){ console.warn('fetch failed', url, e); return null; }
}

/* timeframe */
function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x;}
function endOfWeek(d){ const x=startOfWeek(d); x.setDate(x.getDate()+6); return x;}
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function iso(d){ return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
function computeRange(sel){
  const now=new Date(); now.setHours(0,0,0,0);
  const y=new Date(now); y.setDate(y.getDate()-1);
  const thisW={from:startOfWeek(now),to:endOfWeek(now)};
  const lastW={from:new Date(startOfWeek(now)),to:new Date(endOfWeek(now))}; lastW.from.setDate(lastW.from.getDate()-7); lastW.to.setDate(lastW.to.getDate()-7);
  const thisM={from:startOfMonth(now),to:endOfMonth(now)};
  const lastM={from:startOfMonth(new Date(now.getFullYear(),now.getMonth()-1,1)),to:endOfMonth(new Date(now.getFullYear(),now.getMonth()-1,1))};
  switch(sel){
    case 'today'    : return {from:iso(now), to:iso(now)};
    case 'yesterday': return {from:iso(y),   to:iso(y)};
    case 'week'     : return {from:iso(thisW.from), to:iso(thisW.to)};
    case 'lastweek' : return {from:iso(lastW.from), to:iso(lastW.to)};
    case 'month'    : return {from:iso(thisM.from), to:iso(thisM.to)};
    case 'lastmonth': return {from:iso(lastM.from), to:iso(lastM.to)};
    case 'r7'       : { const s=new Date(now); s.setDate(s.getDate()-6);  return {from:iso(s), to:iso(now)}; }
    case 'r30'      : { const s=new Date(now); s.setDate(s.getDate()-29); return {from:iso(s), to:iso(now)}; }
    default         : { const s=new Date(now); s.setDate(s.getDate()-29); return {from:iso(s), to:iso(now)}; }
  }
}

/* mappings.json support */
let MAPPINGS=null;
async function loadMappings(){
  const j = await fetchJSON(`${ENDPOINTS.MAP}?ts=${Date.now()}`);
  MAPPINGS = j || { capacities_lbs_hr:{}, capacity_by_material_lbs_hr:{}, capacity_aliases:{}, material_aliases:{}, productionAssets:[] };
}
function capacityFor(lineName, material){
  const { capacities_lbs_hr: caps = {}, capacity_by_material_lbs_hr: byMat = {}, capacity_aliases: alias = {}, material_aliases: malias = {} } = MAPPINGS || {};
  const canon = (caps[lineName] !== undefined || byMat[lineName]) ? lineName : (alias[lineName] || lineName);
  const k = String(material ?? '').trim().toUpperCase();
  const m = malias[k] || (k === '' ? 'DEFAULT' : k);
  return byMat[canon]?.[m] ?? byMat[canon]?.DEFAULT ?? caps[canon] ?? 0;
}
// Build a reverse alias map: aliasName -> canonicalName
function aliasToCanonMap() {
  const a = (MAPPINGS?.capacity_aliases) || {};
  const rev = new Map();
  Object.keys(a).forEach(canon => {
    const aliases = Array.isArray(a[canon]) ? a[canon] : [a[canon]].filter(Boolean);
    aliases.forEach(x => rev.set(String(x).trim(), canon));
  });
  return rev;
}

// Canonicalize any machine name using capacity_aliases (fallback: itself)
function canonName(name) {
  const n = String(name||'').trim();
  const rev = aliasToCanonMap();
  return rev.get(n) || n;
}

// productionAssets can be strings or {name: "..."}
function mappedMachineNames() {
  const arr = Array.isArray(MAPPINGS?.productionAssets) ? MAPPINGS.productionAssets : [];
  return arr.map(x => (typeof x === 'string' ? x : (x?.name||'')).trim()).filter(Boolean);
}
function mappedMachineNames(){
  const arr = Array.isArray(MAPPINGS?.productionAssets) ? MAPPINGS.productionAssets : [];
  return arr.map(x => (typeof x === 'string' ? x : (x?.name||'')).trim()).filter(Boolean);
}

/* donuts (placeholder) */
function drawDonut(canvas, mainPct, mainColor, otherColor){
  const ctx = canvas.getContext('2d');
  const {width:w,height:h} = canvas; ctx.clearRect(0,0,w,h);
  const cx=w/2, cy=h/2, r=Math.min(w,h)/2-6, t=24;
  const A = Math.max(0,Math.min(100,mainPct));
  const parts = [{v:A,c:mainColor},{v:100-A,c:otherColor}];
  let start=-Math.PI/2;
  parts.forEach(p=>{
    const ang = (p.v/100)*Math.PI*2;
    ctx.beginPath(); ctx.arc(cx,cy,r,start,start+ang); ctx.arc(cx,cy,r-t,start+ang,start,true); ctx.closePath();
    ctx.fillStyle=p.c; ctx.fill(); start+=ang;
  });
  ctx.fillStyle='#111'; ctx.font='800 20px system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(`${Math.round(A)}%`, cx, cy);
}

/* prodstatus (normalized) */
async function loadProdStatus(){
  const raw = await fetchJSON(`${ENDPOINTS.PRODSTATUS}?t=${Date.now()}`);
  if (!raw) return null;
  let rows = Array.isArray(raw?.rows) ? raw.rows : (Array.isArray(raw?.tiles) ? raw.tiles : []);
  if (Array.isArray(rows) && rows.length === 1 && rows[0] && typeof rows[0] === 'object') {
    const k=Object.keys(rows[0])[0], v=rows[0][k];
    if (typeof v === 'string' && v.startsWith('[')) { try{ rows = JSON.parse(v); }catch{} }
  }
  if (!Array.isArray(rows) || !rows.length) return null;
  return rows.map(r=>{
    const name = r.assetName || r.name || r.AssetName || r.machine || r.asset || 'Unknown';
    const val  = (r.assetStatus ?? r.value ?? r.valueText ?? r.statusText ?? r.status ?? r.statusID ?? '').toString().trim();
    const txt  = val.replace(/\u00A0/g,' ').toLowerCase();
    let status='downp';
    if (txt.includes('setup')) status='setup';
    else if (txt.includes('maint')) status='downm';
    else if (txt.includes('avail') || txt==='running' || txt==='run') status='available';
    const limble = /limble|work ?order|wo/i.test(val);
    return {name, status, limble};
  });
}

/* ===== render ===== */
let STATE = { period:'lastweek', refreshEvery:60 };

async function renderAll(){
  setLoading(true);
  try{
    const names = {today:'Today',yesterday:'Yesterday',week:'This Week',lastweek:'Last Week',month:'This Month',lastmonth:'Last Month',r7:'Rolling 7d',r30:'Rolling 30d'};
    $('#periodLabel').textContent = '‚Ä¢ ' + (names[STATE.period]||'Range');
    document.querySelectorAll('.segBig button').forEach(b=>b.classList.toggle('active', b.dataset.period===STATE.period));

    if (!MAPPINGS) await loadMappings();
    const allow = new Set(mappedMachineNames().map(canonName));
    const isAllowed = (m) => allow.size ? allow.has(canonName(m)) : true;

    const {from,to} = computeRange(STATE.period);
    const [summary, bylineRaw, prodstatus] = await Promise.all([
      fetchJSON(`${ENDPOINTS.SUMMARY}?from=${from}&to=${to}`),
      fetchJSON(`${ENDPOINTS.BY_LINE}?from=${from}&to=${to}`),
      loadProdStatus()
    ]);

    // filter by mappings if provided
    const byline = (bylineRaw || []).filter(r => r.machine && isAllowed(r.machine));

    // === Compute KPIs only from by-line, like production.html ===
    const dates = [...new Set((byline||[]).map(r => (r.src_date||'').slice(0,10)).filter(Boolean))].sort();
    
    // 1) per-day per-machine
    const dayMap = new Map(); // key: `${canon(machine)}__${date}` -> {lbs, run, maint, cap}
    for (const r of (byline || [])) {
      const mCanon = canonName(r.machine);
      const d = (r.src_date || '').slice(0,10);
      if (!mCanon || !d) continue;
      const k = `${mCanon}__${d}`;
      if (!dayMap.has(k)) dayMap.set(k, { lbs:0, run:0, maint:0, cap:0 });
      const o = dayMap.get(k);
      o.lbs   += +r.pounds || 0;
      o.run    = Math.max(o.run,   +r.machine_hours || 0);
      o.maint  = Math.max(o.maint, +r.maint_dt_h    || 0);
      const cap = capacityFor(mCanon, r.material) || +r.nameplate_lbs_hr || 0;
      o.cap = Math.max(o.cap, cap);
    }
    
    // 2) aggregate over the timeframe
    let sumLbs=0, sumRun=0, sumMaint=0, adjDen=0;
    for (const o of dayMap.values()) {
      sumLbs  += o.lbs;
      sumRun  += o.run;
      sumMaint+= o.maint;
      adjDen  += o.cap * Math.max(0, 24 - o.maint);
    }
    const dayCount = dates.length || 1;
    const avail = sumRun / (24 * dayCount);
    const perfA = adjDen > 0 ? Math.min(1, sumLbs / adjDen) : 0;
    const oee   = avail * perfA * 0.70;  // Quality fixed at 70% like prod
    
    const oeePct  = Math.round(oee * 100);
    const avlPct  = Math.round(avail * 100);
    const perfPct = Math.round(perfA * 100);
    const qualPct = 70;
    const pounds  = Math.round(sumLbs);

    // per-machine series (OEE per day)
    dates.forEach(d => {
      // collect machines that had any record that day
      const todaysMachines = [...new Set((byline||[]).filter(r => (r.src_date||'').slice(0,10)===d)
        .map(r => canonName(r.machine)))];
    
      todaysMachines.forEach(m => {
        const o = dayMap.get(`${m}__${d}`);
        if (!o) return;
        const availD = o.run / 24;
        const perfD  = o.cap > 0 ? Math.min(1, o.lbs / Math.max(1, o.cap * (24 - o.maint))) : 0;
        const oeeD   = Math.round(availD * perfD * 0.70 * 100);
        (seriesBy[m] ||= []).push(isFinite(oeeD) ? oeeD : 0);
      });
    });

    const needFallback = !(oeePct||avlPct||perfPct||pounds);
    if (needFallback && byline.length){
      const dayMap=new Map(), dates=new Set();
      for(const r of byline){
        const m=r.machine, d=(r.src_date||'').slice(0,10); if(!m||!d) continue;
        dates.add(d);
        const k=`${m}__${d}`;
        if(!dayMap.has(k)) dayMap.set(k,{lbs:0,run:0,maint:0,cap:0});
        const o=dayMap.get(k);
        o.lbs+= +r.pounds||0; o.run=Math.max(o.run, +r.machine_hours||0); o.maint=Math.max(o.maint, +r.maint_dt_h||0);
        const cap = capacityFor(m, r.material) || +r.nameplate_lbs_hr || 0;
        o.cap = Math.max(o.cap, cap);
      }
      let sumLbs=0,sumRun=0,sumMaint=0,adjDen=0;
      for(const o of dayMap.values()){
        sumLbs+=o.lbs; sumRun+=o.run; sumMaint+=o.maint;
        adjDen+= o.cap * Math.max(0, HOURS_PER_DAY - o.maint);
      }
      const dayCount = dates.size || 1;
      const avail = sumRun/(HOURS_PER_DAY*dayCount);
      const perfA = adjDen>0 ? Math.min(1, sumLbs/adjDen) : 0;
      const oee   = avail * perfA * QUALITY_DEFAULT;
      oeePct=Math.round(oee*100); avlPct=Math.round(avail*100); perfPct=Math.round(perfA*100);
      qualPct=Math.round(QUALITY_DEFAULT*100); pounds=Math.round(sumLbs);
    }

    // KPIs
    const kpiStrip=$('#kpiStrip'); kpiStrip.innerHTML='';
    [
      {label:'OEE', value:`${oeePct}%`, cls: classForKPI(oeePct)},
      {label:'Availability', value:`${avlPct}%`, cls: classForKPI(avlPct)},
      {label:'Performance (Adj)', value:`${perfPct}%`, cls: classForKPI(perfPct)},
      {label:'Quality', value:`${qualPct}%`, cls: classForQuality(qualPct)},
      {label:'Total Pounds', value: fmt(pounds)},
      {label:'Missed Opp', value: '‚Äî'}
    ].forEach(k=>{
      const div=document.createElement('div'); div.className=`kpi ${k.cls||''}`.trim();
      div.innerHTML=`<div class="label">${k.label}</div><div class="value">${k.value}</div>`;
      kpiStrip.appendChild(div);
    });

    // Downtime pies placeholder (0/100)
    drawDonut($('#donutMaint'), 0, '#ef4444', '#f59e0b');
    $('#legendMaint').innerHTML =
      `<div class="row"><span class="dot" style="background:#ef4444;width:12px;height:12px;border-radius:3px"></span><span class="name" style="font-weight:800">Maintenance</span><span style="margin-left:auto;color:var(--muted);font-weight:800">0%</span></div>
       <div class="row"><span class="dot" style="background:#f59e0b;width:12px;height:12px;border-radius:3px"></span><span class="name" style="font-weight:800">Other</span><span style="margin-left:auto;color:var(--muted);font-weight:800">100%</span></div>`;
    drawDonut($('#donutProd'), 0, '#0ea5e9', '#a78bfa');
    $('#legendProd').innerHTML =
      `<div class="row"><span class="dot" style="background:#0ea5e9;width:12px;height:12px;border-radius:3px"></span><span class="name" style="font-weight:800">Production</span><span style="margin-left:auto;color:var(--muted);font-weight:800">0%</span></div>
       <div class="row"><span class="dot" style="background:#a78bfa;width:12px;height:12px;border-radius:3px"></span><span class="name" style="font-weight:800">Other</span><span style="margin-left:auto;color:var(--muted);font-weight:800">100%</span></div>`;

    // Status (filtered by mappings)
    const statusRaw = Array.isArray(prodstatus) ? prodstatus : [];
    const statusArr = (Array.isArray(prodstatus) ? prodstatus : [])
      .filter(s => isAllowed(s.name))
      .sort((a,b)=> a.name.localeCompare(b.name));

    const statusBar=$('#statusBar'); statusBar.innerHTML='';
    const prodList=$('#prodStatusList'); prodList.innerHTML='';
    statusArr.forEach(S=>{
      const dot = S.status==='available'?'st-available':S.status==='setup'?'st-setup':S.status==='downm'?'st-downm':'st-downp';
      const wrench = S.limble? '<span title="Open Limble request" style="font-weight:900">üõ†Ô∏è</span>' : '';
      const chip=document.createElement('div'); chip.className='chip';
      chip.innerHTML = `<span class="dot ${dot}"></span><strong>${S.name}</strong><span style="color:var(--muted);font-weight:800">${S.status.toUpperCase()}</span>${wrench}`;
      statusBar.appendChild(chip);

      const row=document.createElement('div');
      const bg=S.limble?'#fff7cc':'#eaffea', border=S.limble?'#fde68a':'#bbf7d0';
      row.style.cssText=`display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:10px 12px;border-radius:12px;background:${bg};border:1px solid ${border}`;
      row.innerHTML=`<strong>${S.name}</strong><span style="color:var(--muted);font-weight:800">${S.limble?'Limble Request':'Available'}</span>`;
      prodList.appendChild(row);
    });

    // Line tiles: compute per-day OEE series with capacity mapping (display-level)
    const seriesBy={}, uniqMachines=[...new Set(byline.map(r=>r.machine))].filter(Boolean)
      .filter(m => allow.size ? allow.has(m) : true).sort();
    const byKey=(m,d)=>`${m}__${d}`, dayCalc=new Map();
    for (const r of byline){
      const m=r.machine, d=(r.src_date||'').slice(0,10); if(!m||!d) continue;
      const k=byKey(m,d);
      if(!dayCalc.has(k)) dayCalc.set(k,{lbs:0,run:0,maint:0,cap:0});
      const o=dayCalc.get(k);
      o.lbs+= +r.pounds||0; o.run=Math.max(o.run, +r.machine_hours||0); o.maint=Math.max(o.maint, +r.maint_dt_h||0);
      const cap=capacityFor(m, r.material) || +r.nameplate_lbs_hr || 0; o.cap=Math.max(o.cap,cap);
    }
    // Build series
    uniqMachines.forEach(m=>{
      seriesBy[m]=[];
      dates.forEach(d=>{
        const o=dayCalc.get(byKey(m,d));
        if(!o){ seriesBy[m].push(0); return; }
        const avail=o.run/HOURS_PER_DAY;
        const perfA = o.cap>0 ? Math.min(1, o.lbs/Math.max(1,o.cap*(HOURS_PER_DAY-o.maint))) : 0;
        const oee=Math.round(avail*perfA*QUALITY_DEFAULT*100);
        seriesBy[m].push(isFinite(oee)?oee:0);
      });
    });

    const linesGrid=$('#linesGrid'); linesGrid.innerHTML='';
    uniqMachines.forEach(m=>{
      const series = seriesBy[m]||[];
      const last = series.length ? series[series.length-1] : oeePct;
      const cls = classForKPI(last);
      const el=document.createElement('div'); el.className='line';
      el.innerHTML=`
        <div class="lineheader">
          <div class="linename">${m}</div>
          <div><span class="badge ${cls}">${cls.toUpperCase()}</span></div>
        </div>
        <div class="metricrow">
          <div class="mitem"><div class="label">OEE</div><div class="mkv">${last}%</div></div>
          <div class="mitem"><div class="label">Avail</div><div class="mkv">${avlPct}%</div></div>
          <div class="mitem"><div class="label">Perf</div><div class="mkv">${perfPct}%</div></div>
          <div class="mitem"><div class="label">Quality</div><div class="mkv">${Math.round(QUALITY_DEFAULT*100)}%</div></div>
        </div>
        <canvas class="spark" width="340" height="40"></canvas>`;
      linesGrid.appendChild(el);
      // sparkline
      const ctx=el.querySelector('canvas').getContext('2d'), w=340, h=40;
      ctx.clearRect(0,0,w,h);
      if(series.length){
        const min=Math.min(...series), max=Math.max(...series), pad=4;
        const x=i=>pad+(w-2*pad)*(i/(series.length-1)), y=v=>h-pad-(h-2*pad)*((v-min)/Math.max(1,(max-min)));
        ctx.beginPath(); ctx.moveTo(x(0),y(series[0])); for(let i=1;i<series.length;i++) ctx.lineTo(x(i),y(series[i]));
        ctx.lineTo(w-pad,h-pad); ctx.lineTo(pad,h-pad); ctx.closePath();
        ctx.fillStyle='rgba(37,64,143,.12)'; ctx.fill();
        ctx.beginPath(); ctx.moveTo(x(0),y(series[0])); for(let i=1;i<series.length;i++) ctx.lineTo(x(i),y(series[i]));
        ctx.lineWidth=2; ctx.strokeStyle='rgba(37,64,143,.9)'; ctx.stroke();
      }
    });

    // Rank table
    const tbody=$('#rankTable tbody'); tbody.innerHTML='';
    uniqMachines.map(m=>{
      const lbs = (byline||[]).filter(r=>r.machine===m).reduce((s,r)=>s+(+r.pounds||0),0);
      const last = (seriesBy[m]||[]).slice(-1)[0] ?? oeePct;
      return {name:m, lbs, oee:last};
    }).sort((a,b)=>b.oee-a.oee).forEach(L=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${L.name}</td><td><strong>${L.oee}%</strong></td><td>${fmt(L.lbs)}</td><td>‚Äî</td>`;
      tbody.appendChild(tr);
    });

    $('#updated').textContent = new Date().toLocaleString();
  } finally {
    setLoading(false);
  }
}

/* controls/timers */
document.querySelectorAll('.segBig button').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.segBig button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    STATE.period = b.dataset.period;
    renderAll();
  });
});
document.getElementById('refreshSec').textContent = '60s';
setInterval(()=>{ const c=$('#clock'); if(c) c.textContent=new Date().toLocaleTimeString(); }, 500);
setInterval(()=>{ renderAll(); }, 60000);

/* initial render (default Last Week) */
renderAll();
</script>
</body>
</html>
