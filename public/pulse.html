<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRI Pulse</title>
  <style>
    :root{
      --pri-blue:#25408F; --pri-green:#92D050;
      --bg:#E9EDF5; --card:#FBFCFE; --ink:#0F172A; --muted:#475569; --border:#D7E0F3;
      --good-bg:#dcfce7;  --good-fg:#065f46;
      --warn-bg:#fef9c3;  --warn-fg:#7c5e10;
      --bad-bg:#fee2e2;   --bad-fg:#7f1d1d;
      --shadow: 0 10px 25px rgba(0,0,0,.08);
      --chip:#f7fafc;
    }
    *{box-sizing:border-box}

    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .page-production::before{
      content:"";position:fixed;inset:0;z-index:-1;
      background:
        linear-gradient(to bottom, rgba(255,255,255,.75), rgba(255,255,255,.85)),
        url('img/PRIfront.png') center/cover no-repeat fixed;
    }
    .top-border{position:fixed;top:0;left:0;width:100%;height:96px;background:var(--pri-green);z-index:10;display:flex;align-items:center;padding:0 20px}
    .top-border .logo{height:72px}
    .top-title{font-size:28px;font-weight:900;margin-left:20px;color:#0A2A12}
    .tabs{margin-left:auto;display:flex;gap:8px;align-items:center}
    .tab{background:#ffffffd9;padding:8px 12px;border-radius:10px;text-decoration:none;color:#0A2A12;font-weight:700}
    .tab.active{background:#fff}
    .wrap{margin:120px 20px 40px 20px}

    .app{max-width:1920px;margin:0 auto}
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin:10px 0 16px;gap:10px;flex-wrap:wrap}
    .left, .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .segBig{display:inline-flex;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card);box-shadow:var(--shadow)}
    .segBig button{border:0;background:transparent;padding:8px 12px;font-weight:700;color:var(--muted);cursor:pointer}
    .segBig button.active{background:var(--pri-blue);color:white}
    .pill{padding:6px 10px;border-radius:999px;background:white;border:1px solid var(--border);color:var(--muted);font-weight:700}

    .kpis{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:12px}
    .kpi{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px 16px;box-shadow:var(--shadow);min-height:90px}
    .kpi .label{font-size:12px;color:var(--muted);font-weight:800;text-transform:uppercase;letter-spacing:.6px}
    .kpi .value{font-size:32px;font-weight:900;margin-top:6px}
    .kpi.good{background:var(--good-bg);color:var(--good-fg);border-color:#bbf7d0}
    .kpi.warn{background:var(--warn-bg);color:var(--warn-fg);border-color:#fde68a}
    .kpi.bad{ background:var(--bad-bg); color:var(--bad-fg); border-color:#fecaca}

    .statusbar{display:flex;gap:10px;overflow:auto;padding:8px 2px;margin-bottom:14px}
    .chip{display:flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:var(--chip);white-space:nowrap}
    .dot{width:12px;height:12px;border-radius:50%}
    .st-available{background:#16a34a}
    .st-setup{background:#f59e0b}
    .st-downm{background:#ef4444}
    .st-downp{background:#dc2626}

    .grid{display:grid;grid-template-columns: 430px 1fr;gap:16px;align-items:stretch}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow)}
    .card h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px;letter-spacing:.3px;color:var(--muted)}
    .card .content{padding:14px}

    /* Hide downtime until wired to real ‚Äúwhy‚Äù data */
    .card.downtime{display:none}

    .lines{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .line{border:1px solid var(--border);border-radius:14px;padding:12px;background:white}
    .lineheader{display:flex;justify-content:space-between;align-items:center}
    .linename{font-weight:900}
    .badge{font-size:12px;font-weight:900;padding:4px 8px;border-radius:999px}
    .badge.good{background:var(--good-bg);color:var(--good-fg);border:1px solid #bbf7d0}
    .badge.warn{background:var(--warn-bg);color:var(--warn-fg);border:1px solid #fde68a}
    .badge.bad{ background:var(--bad-bg); color:var(--bad-fg); border:1px solid #fecaca}
    .metricrow{display:grid;grid-template-columns: repeat(4,1fr);gap:8px;margin-top:8px}
    .mitem{background:#f7fafc;border:1px solid var(--border);border-radius:10px;padding:8px}
    .mitem .mkv{font-size:22px;font-weight:900}
    .spark{width:100%;height:40px;margin-top:6px}

    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px dashed var(--border)}
    th{text-align:left;color:var(--muted);font-weight:900}

    footer{display:flex;justify-content:space-between;align-items:center;margin-top:12px;color:var(--muted)}
    .clock{font-variant-numeric:tabular-nums;font-weight:900}

    @media (min-width:2560px){
      .app{max-width:2560px}
      .kpi .value{font-size:46px}
      .kpi .label, .badge{font-size:16px}
      .spark{height:54px}
      .lines{gap:18px}
      .line{padding:16px}
      table{font-size:18px}
    }
  </style>
</head>

<body class="page-production">
  <div class="top-border">
    <img src="img/pri-logo.png" alt="PRI Logo" class="logo" />
    <div class="top-title">PRI Pulse <span id="periodLabel" style="font-size:16px;font-weight:800;margin-left:8px;color:#0A2A12"></span></div>
    <div class="tabs">
      <a class="tab" href="index.html">Work Orders</a>
      <a class="tab" href="pm.html">PM</a>
      <a class="tab" href="prodstatus.html">Prod Status</a>
      <a class="tab" href="kpi-by-asset.html">KPIs by Asset</a>
      <a class="tab" href="production.html">Transformation</a>
      <a class="tab active" href="pulse.html">Pulse</a>
      <a class="tab" href="admin">Admin</a>
      <img src="img/innovation-logo.png" alt="Innovation" style="height:60px;margin-left:6px;background:#fff;border-radius:8px;padding:4px"/>
    </div>
  </div>

  <div class="wrap">
    <div class="app" id="app">

      <div class="toolbar">
        <div class="left">
          <div class="segBig" role="tablist" aria-label="Timeframe">
            <button data-period="today" class="active" role="tab">Today</button>
            <button data-period="yesterday" role="tab">Yesterday</button>
            <button data-period="week" role="tab">This Week</button>
            <button data-period="lastweek" role="tab">Last Week</button>
            <button data-period="month" role="tab">This Month</button>
            <button data-period="lastmonth" role="tab">Last Month</button>
            <button data-period="r7" role="tab">Rolling 7d</button>
            <button data-period="r30" role="tab">Rolling 30d</button>
          </div>
          <span class="pill" id="sitePill">All Sites</span>
        </div>
        <div class="right">
          <span class="pill">Auto-refresh: <strong id="refreshSec">60s</strong></span>
          <span class="pill">Press <strong>F</strong> for Fullscreen</span>
        </div>
      </div>

      <!-- STATUS TICKER -->
      <div class="statusbar" id="statusBar" aria-label="Line availability and Limble status"></div>

      <!-- KPI STRIP -->
      <section class="kpis" id="kpiStrip"></section>

      <section class="grid">
        <!-- Left: (hidden) downtime card placeholder -->
        <article class="card downtime">
          <h3>Downtime Overview ‚Äî Maintenance vs Production</h3>
          <div class="content donutwrap">
            <div class="donutrow">
              <canvas id="donutMaint" width="160" height="160"></canvas>
              <div><div class="legend" id="legendMaint"></div></div>
            </div>
            <div class="donutrow">
              <canvas id="donutProd" width="160" height="160"></canvas>
              <div><div class="legend" id="legendProd"></div></div>
            </div>
          </div>
        </article>

        <!-- Right: Line health -->
        <article class="card">
          <h3>Line Health (OEE / Avail / Perf / Quality)</h3>
          <div class="content">
            <div class="lines" id="linesGrid"></div>
          </div>
        </article>
      </section>

      <!-- Bottom row: Production line status + Rank table -->
      <section class="grid" style="margin-top:16px">
        <article class="card">
          <h3>Production Line Status</h3>
          <div class="content" id="prodStatusList"></div>
        </article>
        <article class="card">
          <h3>Lines Ranked by OEE & Missed Opportunity</h3>
          <div class="content">
            <table id="rankTable">
              <thead>
                <tr><th style="width:28%">Line</th><th style="width:14%">OEE %</th><th style="width:22%">Pounds</th><th>Missed Opp (lb)</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </article>
      </section>

      <footer>
        <div>Last updated <span id="updated"></span></div>
        <div class="clock" id="clock"></div>
      </footer>

    </div>
  </div>

<script>
/* ===== endpoints from your server ===== */
const ENDPOINTS = {
  SUMMARY: '/api/production/summary',     // server/routes/production.js
  BY_LINE: '/api/production/by-line',     // server/routes/production.js
  PRODSTATUS: '/api/workorders/prodstatus'// server side used by prodstatus.html
};
const HOURS_PER_DAY = 24;
const QUALITY_DEFAULT = 0.70;

/* thresholds (Quality uses stricter colors so 70% is RED) */
const classForKPI = v => v>=70? 'good' : v>=50? 'warn':'bad';
const classForQuality = v => v>=98? 'good' : v>=85? 'warn' : 'bad';

const $ = s => document.querySelector(s);
const fmtInt = n => Number(Math.round(n||0)).toLocaleString();
const formatISO = d => new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
async function fetchJSON(url){
  try{ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(r.status); return await r.json(); }
  catch(e){ console.warn('fetch failed', url, e); return null; }
}

/* timeframe */
function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x;}
function endOfWeek(d){ const x=startOfWeek(d); x.setDate(x.getDate()+6); return x;}
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function computeRange(sel){
  const now=new Date(); now.setHours(0,0,0,0);
  const y=new Date(now); y.setDate(y.getDate()-1);
  const fmt = d => formatISO(d);
  const thisW={from:startOfWeek(now),to:endOfWeek(now)};
  const lastW={from:new Date(startOfWeek(now)),to:new Date(endOfWeek(now))}; lastW.from.setDate(lastW.from.getDate()-7); lastW.to.setDate(lastW.to.getDate()-7);
  const thisM={from:startOfMonth(now),to:endOfMonth(now)};
  const lastM={from:startOfMonth(new Date(now.getFullYear(),now.getMonth()-1,1)),to:endOfMonth(new Date(now.getFullYear(),now.getMonth()-1,1))};
  switch(sel){
    case 'today':return{from:fmt(now),to:fmt(now)};
    case 'yesterday':return{from:fmt(y),to:fmt(y)};
    case 'week':return{from:fmt(thisW.from),to:fmt(thisW.to)};
    case 'lastweek':return{from:fmt(lastW.from),to:fmt(lastW.to)};
    case 'month':return{from:fmt(thisM.from),to:fmt(thisM.to)};
    case 'lastmonth':return{from:fmt(lastM.from),to:fmt(lastM.to)};
    case 'r7':{const s=new Date(now);s.setDate(s.getDate()-6);return{from:fmt(s),to:fmt(now)};}
    case 'r30':{const s=new Date(now);s.setDate(s.getDate()-29);return{from:fmt(s),to:fmt(now)};}
    default:{const s=new Date(now);s.setDate(s.getDate()-29);return{from:fmt(s),to:fmt(now)};}
  }
}

/* charts */
function drawSparkline(canvas, arr){
  const ctx=canvas.getContext('2d'), w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  if(!arr.length) return;
  const min=Math.min(...arr), max=Math.max(...arr);
  const pad=4, x=i=>pad+(w-2*pad)*(i/(arr.length-1)), y=v=>h-pad-(h-2*pad)*((v-min)/Math.max(1,(max-min)));
  ctx.beginPath(); ctx.moveTo(x(0),y(arr[0])); for(let i=1;i<arr.length;i++) ctx.lineTo(x(i),y(arr[i])); ctx.lineTo(w-pad,h-pad); ctx.lineTo(pad,h-pad); ctx.closePath();
  ctx.fillStyle='rgba(37,64,143,.12)'; ctx.fill();
  ctx.beginPath(); ctx.moveTo(x(0),y(arr[0])); for(let i=1;i<arr.length;i++) ctx.lineTo(x(i),y(arr[i])); ctx.lineWidth=2; ctx.strokeStyle='rgba(37,64,143,.9)'; ctx.stroke();
}

/* ====== PROD STATUS (reuse prodstatus.html logic, simplified) ====== */
async function loadProdStatus(){
  const raw = await fetchJSON(`${ENDPOINTS.PRODSTATUS}?t=${Date.now()}`);
  if (!raw) return null;

  // rows can be in raw.rows or raw.tiles; sometimes SQL wrapper packs JSON string in a single object key
  let rows = Array.isArray(raw?.rows) ? raw.rows : (Array.isArray(raw?.tiles) ? raw.tiles : []);
  if (Array.isArray(rows) && rows.length === 1 && rows[0] && typeof rows[0] === 'object') {
    const k = Object.keys(rows[0])[0];
    const v = rows[0][k];
    if (typeof v === 'string' && v.startsWith('[')) {
      try { rows = JSON.parse(v); } catch {}
    }
  }
  if (!Array.isArray(rows) || !rows.length) return null;

  // Normalize ‚Üí { name, status, limble? }
  return rows.map(r=>{
    const name = r.assetName || r.name || r.AssetName || r.machine || r.asset || 'Unknown';
    const val  = (r.assetStatus ?? r.value ?? r.valueText ?? r.statusText ?? r.status ?? r.statusID ?? '').toString().trim();
    const txt  = val.replace(/\u00A0/g,' ').toLowerCase();
    let status = 'downp';
    if (txt.includes('setup')) status = 'setup';
    else if (txt.includes('maint')) status = 'downm';
    else if (txt.includes('avail') || txt==='running' || txt==='run') status = 'available';
    const limble = /limble|work ?order|wo/i.test(val) ? true : false; // dumb guess if text carries it
    return {name, status, limble};
  });
}

/* render */
let STATE = { period:'today', refreshEvery:60 };

async function renderAll(){
  const names = {today:'Today',yesterday:'Yesterday',week:'This Week',lastweek:'Last Week',month:'This Month',lastmonth:'Last Month',r7:'Rolling 7d',r30:'Rolling 30d'};
  document.getElementById('periodLabel').textContent = '‚Ä¢ ' + (names[STATE.period]||'Range');
  const {from,to} = computeRange(STATE.period);

  // Pull summary + by-line
  const [summary, byline, prodstatus] = await Promise.all([
    fetchJSON(`${ENDPOINTS.SUMMARY}?from=${from}&to=${to}`),
    fetchJSON(`${ENDPOINTS.BY_LINE}?from=${from}&to=${to}`),
    loadProdStatus() // may be null
  ]);

  // Fallbacks if summary empty
  const oeePct   = Math.round(((summary?.oee) ?? 0) * 100);
  const avlPct   = Math.round(((summary?.availability) ?? 0) * 100);
  const perfPct  = Math.round(((summary?.performanceAdj ?? summary?.performance) ?? 0) * 100);
  const qualPct  = Math.round((summary?.quality ?? QUALITY_DEFAULT) * 100);
  const pounds   = Math.round(summary?.pounds ?? summary?.totalPounds ?? 0);

  // KPI strip (quality uses its own thresholds ‚Üí 70% shows BAD/red)
  const kpiStrip = document.getElementById('kpiStrip'); kpiStrip.innerHTML='';
  [
    {label:'OEE', value:`${isFinite(oeePct)?oeePct:0}%`, cls: classForKPI(oeePct||0)},
    {label:'Availability', value:`${isFinite(avlPct)?avlPct:0}%`, cls: classForKPI(avlPct||0)},
    {label:'Performance (Adj)', value:`${isFinite(perfPct)?perfPct:0}%`, cls: classForKPI(perfPct||0)},
    {label:'Quality', value:`${qualPct}%`, cls: classForQuality(qualPct)},
    {label:'Total Pounds', value: fmtInt(pounds||0)},
    {label:'Missed Opp', value: '‚Äî'}
  ].forEach(k=>{
    const div = document.createElement('div');
    div.className = `kpi ${k.cls||''}`.trim();
    div.innerHTML = `<div class="label">${k.label}</div><div class="value">${k.value}</div>`;
    kpiStrip.appendChild(div);
  });

  // Status bar + Production status list
  const statusBar = document.getElementById('statusBar'); statusBar.innerHTML='';
  const prodList  = document.getElementById('prodStatusList'); prodList.innerHTML='';

  const statusArr = Array.isArray(prodstatus) ? prodstatus
                    : [...new Set((byline||[]).map(r=>r.machine).filter(Boolean))].map(m=>({name:m,status:'downp',limble:false}));

  statusArr.sort((a,b)=> a.name.localeCompare(b.name));
  statusArr.forEach(S=>{
    const dot = S.status==='available' ? 'st-available' : S.status==='setup' ? 'st-setup' : S.status==='downm' ? 'st-downm' : 'st-downp';
    const wrench = S.limble ? '<span title="Open Limble request" style="font-weight:900">üõ†Ô∏è</span>' : '';
    const chip=document.createElement('div'); chip.className='chip';
    chip.innerHTML = `<span class="dot ${dot}"></span><strong>${S.name}</strong><span style="color:var(--muted);font-weight:800">${S.status.toUpperCase()}</span>${wrench}`;
    statusBar.appendChild(chip);

    const row=document.createElement('div');
    const bg = S.limble ? '#fff7cc' : '#eaffea';
    const border = S.limble ? '#fde68a' : '#bbf7d0';
    row.style.cssText = `display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;padding:10px 12px;border-radius:12px;background:${bg};border:1px solid ${border}`;
    row.innerHTML = `<strong>${S.name}</strong><span style="color:var(--muted);font-weight:800">${S.limble?'Limble Request':'Available'}</span>`;
    prodList.appendChild(row);
  });

  // Line health grid (sparkline from per-day OEE-ish using by-line)
  const seriesBy = {};
  (byline||[]).forEach(r=>{
    const m=r.machine; if(!m) return;
    const d=(r.src_date||'').slice(0,10); if(!d) return;
    seriesBy[m] ??= [];
    const run=+r.machine_hours||0, md=+r.maint_dt_h||0, lbs=+r.pounds||0;
    const avail = run / HOURS_PER_DAY;
    const perf  = (HOURS_PER_DAY-md)>0 ? Math.min(1, lbs/Math.max(1,(HOURS_PER_DAY-md))) : 0;
    const oee   = Math.round(avail*perf*QUALITY_DEFAULT*100);
    seriesBy[m].push(oee);
  });

  const linesGrid = document.getElementById('linesGrid'); linesGrid.innerHTML='';
  const uniqMachines = [...new Set((byline||[]).map(r=>r.machine).filter(Boolean))].sort();
  uniqMachines.forEach(m=>{
    const series = seriesBy[m]||[];
    const last = series.length ? series[series.length-1] : (oeePct||0);
    const el=document.createElement('div'); el.className='line';
    const cls=classForKPI(last);
    el.innerHTML=`
      <div class="lineheader">
        <div class="linename">${m}</div>
        <div><span class="badge ${cls}">${cls.toUpperCase()}</span></div>
      </div>
      <div class="metricrow">
        <div class="mitem"><div class="label">OEE</div><div class="mkv">${last}%</div></div>
        <div class="mitem"><div class="label">Avail</div><div class="mkv">${isFinite(avlPct)?avlPct:0}%</div></div>
        <div class="mitem"><div class="label">Perf</div><div class="mkv">${isFinite(perfPct)?perfPct:0}%</div></div>
        <div class="mitem"><div class="label">Quality</div><div class="mkv">${Math.round(QUALITY_DEFAULT*100)}%</div></div>
      </div>
      <canvas class="spark" width="340" height="40"></canvas>
    `;
    linesGrid.appendChild(el);
    drawSparkline(el.querySelector('canvas'), series);
  });

  // Rank table
  const tbody=document.querySelector('#rankTable tbody'); tbody.innerHTML='';
  uniqMachines.map(m=>{
    const lbs = (byline||[]).filter(r=>r.machine===m).reduce((s,r)=>s+(+r.pounds||0),0);
    const last = (seriesBy[m]||[]).slice(-1)[0] ?? (oeePct||0);
    return {name:m, lbs, oee:last};
  }).sort((a,b)=>b.oee-a.oee).forEach(L=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${L.name}</td><td><strong>${L.oee}%</strong></td><td>${fmtInt(L.lbs)}</td><td>‚Äî</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('updated').textContent = new Date().toLocaleString();
}

/* controls/timers */
document.querySelectorAll('.segBig button').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.segBig button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    STATE.period = b.dataset.period;
    renderAll();
  });
});
document.getElementById('refreshSec').textContent = STATE.refreshEvery+'s';
setInterval(()=>{ const c=document.getElementById('clock'); if(c) c.textContent=new Date().toLocaleTimeString(); }, 500);
setInterval(()=>{ renderAll(); }, STATE.refreshEvery*1000);

renderAll();
</script>
</body>
</html>
